(window.webpackJsonp=window.webpackJsonp||[]).push([[33],{476:function(s,a,t){s.exports=t.p+"assets/img/image-20200621170407068.d736a785.png"},477:function(s,a,t){s.exports=t.p+"assets/img/image-20200621170720454.2eae8b9e.png"},478:function(s,a,t){s.exports=t.p+"assets/img/image-20200621170912726.556737d6.png"},706:function(s,a,t){"use strict";t.r(a);var e=t(15),r=Object(e.a)({},(function(){var s=this,a=s.$createElement,e=s._self._c||a;return e("ContentSlotsDistributor",{attrs:{"slot-key":s.$parent.slotKey}},[e("h1",{attrs:{id:"全局主键"}},[e("a",{staticClass:"header-anchor",attrs:{href:"#全局主键"}},[s._v("#")]),s._v(" 全局主键")]),s._v(" "),e("p",[s._v("在数据库集群的场景下，使用数据库主键自增长，会产生重复主键记录。")]),s._v(" "),e("p",[e("img",{attrs:{src:t(476),alt:"image-20200621170407068"}})]),s._v(" "),e("p",[s._v("在数据库集群环境中，应该使用中间件来生成主键值。")]),s._v(" "),e("p",[s._v("Mycat 支持多种 "),e("strong",[s._v("全局主键")]),s._v(" 生成方式，其中最好的是 Zookeeper 方式。")]),s._v(" "),e("h2",{attrs:{id:"本地文件方式"}},[e("a",{staticClass:"header-anchor",attrs:{href:"#本地文件方式"}},[s._v("#")]),s._v(" 本地文件方式")]),s._v(" "),e("p",[s._v("Mycat 按照计数器的放生成自增长的主键值，计数器的参数被保存在文本文件中。")]),s._v(" "),e("p",[s._v("最大的缺点就是：无法与其他 Mycat 通信。比如你部署了主备，其中一个挂掉的时候，另外一个启动起来，无法获取到之前的主键参数。")]),s._v(" "),e("p",[e("img",{attrs:{src:t(477),alt:"image-20200621170720454"}})]),s._v(" "),e("p",[s._v("这种方式只适合测试中使用；")]),s._v(" "),e("h2",{attrs:{id:"数据库方式"}},[e("a",{staticClass:"header-anchor",attrs:{href:"#数据库方式"}},[s._v("#")]),s._v(" 数据库方式")]),s._v(" "),e("p",[s._v("和文件方式类似，只是把计数器的参数保存到数据库中。")]),s._v(" "),e("p",[e("img",{attrs:{src:t(478),alt:"image-20200621170912726"}})]),s._v(" "),e("p",[s._v("缺点：")]),s._v(" "),e("ul",[e("li",[s._v("如果是 pxc 集群：可能会产生一定的性能影响，因为是同步复制")]),s._v(" "),e("li",[s._v("如果是 Replication 集群：如果没有同步成功，第一个 mycat 挂掉了，第二个立即启用，会造成主键重复。")])]),s._v(" "),e("h2",{attrs:{id:"本地时间戳方式"}},[e("a",{staticClass:"header-anchor",attrs:{href:"#本地时间戳方式"}},[s._v("#")]),s._v(" 本地时间戳方式")]),s._v(" "),e("p",[s._v("MyCat 根据本地时间戳和机器 ID ，生成一个 18 位的主键值。")]),s._v(" "),e("p",[s._v("缺点：因为生成的主键值都是偶数，所以无法用在主键求模切分规则上")]),s._v(" "),e("h2",{attrs:{id:"zookeeper-时间戳方式"}},[e("a",{staticClass:"header-anchor",attrs:{href:"#zookeeper-时间戳方式"}},[s._v("#")]),s._v(" Zookeeper 时间戳方式")]),s._v(" "),e("p",[s._v("利用 Zookeeper 生成时间戳主键值（64 位整数），主键字段必须使用 bigint 类型。")]),s._v(" "),e("p",[s._v("可以使用 Zookeeper 集群来保证高可用性。")]),s._v(" "),e("p",[s._v("但是如果使用时间戳，本地为什么做不到有奇数和偶数？")]),s._v(" "),e("h2",{attrs:{id:"安装-zookeeper"}},[e("a",{staticClass:"header-anchor",attrs:{href:"#安装-zookeeper"}},[s._v("#")]),s._v(" 安装 Zookeeper")]),s._v(" "),e("p",[s._v("下载安装 Zookeeper 官方镜像")]),s._v(" "),e("div",{staticClass:"language-bash line-numbers-mode"},[e("pre",{pre:!0,attrs:{class:"language-bash"}},[e("code",[s._v("docker pull zookeeper\n")])]),s._v(" "),e("div",{staticClass:"line-numbers-wrapper"},[e("span",{staticClass:"line-number"},[s._v("1")]),e("br")])]),e("p",[s._v("启动 Zookeeper")]),s._v(" "),e("div",{staticClass:"language-bash line-numbers-mode"},[e("pre",{pre:!0,attrs:{class:"language-bash"}},[e("code",[s._v("docker run -d --name z1 \n-p "),e("span",{pre:!0,attrs:{class:"token number"}},[s._v("2181")]),s._v(":2181\n-p "),e("span",{pre:!0,attrs:{class:"token number"}},[s._v("3888")]),s._v(":3888\n-p "),e("span",{pre:!0,attrs:{class:"token number"}},[s._v("2888")]),s._v(":2888 \n--net"),e("span",{pre:!0,attrs:{class:"token operator"}},[s._v("=")]),s._v("swarm_mysql\nzookeeper\n")])]),s._v(" "),e("div",{staticClass:"line-numbers-wrapper"},[e("span",{staticClass:"line-number"},[s._v("1")]),e("br"),e("span",{staticClass:"line-number"},[s._v("2")]),e("br"),e("span",{staticClass:"line-number"},[s._v("3")]),e("br"),e("span",{staticClass:"line-number"},[s._v("4")]),e("br"),e("span",{staticClass:"line-number"},[s._v("5")]),e("br"),e("span",{staticClass:"line-number"},[s._v("6")]),e("br")])]),e("p",[s._v("实践练习")]),s._v(" "),e("div",{staticClass:"language-bash line-numbers-mode"},[e("pre",{pre:!0,attrs:{class:"language-bash"}},[e("code",[e("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("[")]),s._v("root@study ~"),e("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("]")]),e("span",{pre:!0,attrs:{class:"token comment"}},[s._v("# docker run -d --name z1 -p 2181:2181 -p 3888:3888 -p 2888:2888 --net=swarm_mysql zookeeper")]),s._v("\nbab947328f72d32f95728bf99ab02e2f47dd91f93360512316901283df52676a\n")])]),s._v(" "),e("div",{staticClass:"line-numbers-wrapper"},[e("span",{staticClass:"line-number"},[s._v("1")]),e("br"),e("span",{staticClass:"line-number"},[s._v("2")]),e("br")])]),e("h3",{attrs:{id:"配置-zookeeper-时间戳主键"}},[e("a",{staticClass:"header-anchor",attrs:{href:"#配置-zookeeper-时间戳主键"}},[s._v("#")]),s._v(" 配置 Zookeeper 时间戳主键")]),s._v(" "),e("p",[s._v("编辑 "),e("code",[s._v("server.xml")]),s._v(" 文件")]),s._v(" "),e("div",{staticClass:"language-xml line-numbers-mode"},[e("pre",{pre:!0,attrs:{class:"language-xml"}},[e("code",[e("span",{pre:!0,attrs:{class:"token tag"}},[e("span",{pre:!0,attrs:{class:"token tag"}},[e("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("<")]),s._v("property")]),s._v(" "),e("span",{pre:!0,attrs:{class:"token attr-name"}},[s._v("name")]),e("span",{pre:!0,attrs:{class:"token attr-value"}},[e("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("=")]),e("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v('"')]),s._v("sequnceHandlerType"),e("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v('"')])]),e("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(">")])]),s._v("3"),e("span",{pre:!0,attrs:{class:"token tag"}},[e("span",{pre:!0,attrs:{class:"token tag"}},[e("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("</")]),s._v("property")]),e("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(">")])]),s._v("\n")])]),s._v(" "),e("div",{staticClass:"line-numbers-wrapper"},[e("span",{staticClass:"line-number"},[s._v("1")]),e("br")])]),e("p",[s._v("修改 "),e("code",[s._v("myid.properties")]),s._v(" 文件")]),s._v(" "),e("div",{staticClass:"language-bash line-numbers-mode"},[e("pre",{pre:!0,attrs:{class:"language-bash"}},[e("code",[e("span",{pre:!0,attrs:{class:"token assign-left variable"}},[s._v("loadZk")]),e("span",{pre:!0,attrs:{class:"token operator"}},[s._v("=")]),s._v("true\n"),e("span",{pre:!0,attrs:{class:"token assign-left variable"}},[s._v("zkURL")]),e("span",{pre:!0,attrs:{class:"token operator"}},[s._v("=")]),e("span",{pre:!0,attrs:{class:"token number"}},[s._v("192.168")]),s._v(".56.105:2181\n"),e("span",{pre:!0,attrs:{class:"token assign-left variable"}},[s._v("clusterId")]),e("span",{pre:!0,attrs:{class:"token operator"}},[s._v("=")]),s._v("mycat-cluster-1\n"),e("span",{pre:!0,attrs:{class:"token assign-left variable"}},[s._v("myid")]),e("span",{pre:!0,attrs:{class:"token operator"}},[s._v("=")]),s._v("mycat_fz_01\n"),e("span",{pre:!0,attrs:{class:"token assign-left variable"}},[s._v("clusterSize")]),e("span",{pre:!0,attrs:{class:"token operator"}},[s._v("=")]),e("span",{pre:!0,attrs:{class:"token number"}},[s._v("1")]),s._v("\n"),e("span",{pre:!0,attrs:{class:"token assign-left variable"}},[s._v("clusterNodes")]),e("span",{pre:!0,attrs:{class:"token operator"}},[s._v("=")]),s._v("mycat_fz_01\n"),e("span",{pre:!0,attrs:{class:"token comment"}},[s._v("#server  booster  ;   booster install on db same server,will reset all minCon to 2")]),s._v("\n"),e("span",{pre:!0,attrs:{class:"token assign-left variable"}},[s._v("type")]),e("span",{pre:!0,attrs:{class:"token operator"}},[s._v("=")]),s._v("server\n"),e("span",{pre:!0,attrs:{class:"token comment"}},[s._v("# boosterDataHosts=dataHost1")]),s._v("\n")])]),s._v(" "),e("div",{staticClass:"line-numbers-wrapper"},[e("span",{staticClass:"line-number"},[s._v("1")]),e("br"),e("span",{staticClass:"line-number"},[s._v("2")]),e("br"),e("span",{staticClass:"line-number"},[s._v("3")]),e("br"),e("span",{staticClass:"line-number"},[s._v("4")]),e("br"),e("span",{staticClass:"line-number"},[s._v("5")]),e("br"),e("span",{staticClass:"line-number"},[s._v("6")]),e("br"),e("span",{staticClass:"line-number"},[s._v("7")]),e("br"),e("span",{staticClass:"line-number"},[s._v("8")]),e("br"),e("span",{staticClass:"line-number"},[s._v("9")]),e("br")])]),e("ul",[e("li",[s._v("clusterId：集群名称，可以自己规定")]),s._v(" "),e("li",[s._v("myid：mycat 主机名，也可以自己定义")]),s._v(" "),e("li",[s._v("clusterNodes：mycat 集群有几个节点组成，这里对应的是 myid 的值，多个用逗号分隔")])]),s._v(" "),e("p",[s._v("这里配置 mycat 集群信息。我们这里只有一个 mycat，设置为一个。")]),s._v(" "),e("h3",{attrs:{id:"测试全局主键"}},[e("a",{staticClass:"header-anchor",attrs:{href:"#测试全局主键"}},[s._v("#")]),s._v(" 测试全局主键")]),s._v(" "),e("p",[s._v("可以通过管理端口，热加载配置文件")]),s._v(" "),e("div",{staticClass:"language-bash line-numbers-mode"},[e("pre",{pre:!0,attrs:{class:"language-bash"}},[e("code",[s._v("reload @@config_all"),e("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(";")]),s._v("\n")])]),s._v(" "),e("div",{staticClass:"line-numbers-wrapper"},[e("span",{staticClass:"line-number"},[s._v("1")]),e("br")])]),e("p",[s._v("由于访问的是本机的 zk，所以不需要放开防火墙。")]),s._v(" "),e("p",[s._v("获取全局主键的 sql 语句为")]),s._v(" "),e("div",{staticClass:"language-sql line-numbers-mode"},[e("pre",{pre:!0,attrs:{class:"language-sql"}},[e("code",[e("span",{pre:!0,attrs:{class:"token keyword"}},[s._v("SELECT")]),s._v(" "),e("span",{pre:!0,attrs:{class:"token keyword"}},[s._v("next")]),s._v(" "),e("span",{pre:!0,attrs:{class:"token keyword"}},[s._v("value")]),s._v(" "),e("span",{pre:!0,attrs:{class:"token keyword"}},[s._v("for")]),s._v(" MYCATSEQ_GLOBAL"),e("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(";")]),s._v("\n"),e("span",{pre:!0,attrs:{class:"token comment"}},[s._v("-- 比如返回的主键 ID 是 7326346979595812993")]),s._v("\n")])]),s._v(" "),e("div",{staticClass:"line-numbers-wrapper"},[e("span",{staticClass:"line-number"},[s._v("1")]),e("br"),e("span",{staticClass:"line-number"},[s._v("2")]),e("br")])]),e("h2",{attrs:{id:"把全局主键应用到插入语句中"}},[e("a",{staticClass:"header-anchor",attrs:{href:"#把全局主键应用到插入语句中"}},[s._v("#")]),s._v(" 把全局主键应用到插入语句中")]),s._v(" "),e("p",[s._v("由于主键要求类型为 bigint，这里把  t2 中的 company 表的主键 ID 修改为 bigint 类型；")]),s._v(" "),e("p",[s._v("使用主键的插入语句如下")]),s._v(" "),e("div",{staticClass:"language-sql line-numbers-mode"},[e("pre",{pre:!0,attrs:{class:"language-sql"}},[e("code",[e("span",{pre:!0,attrs:{class:"token keyword"}},[s._v("INSERT")]),s._v(" "),e("span",{pre:!0,attrs:{class:"token keyword"}},[s._v("INTO")]),s._v(" company "),e("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("(")]),s._v(" id"),e("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(",")]),s._v(" name"),e("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(",")]),s._v(" city_id "),e("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(")")]),s._v("\n"),e("span",{pre:!0,attrs:{class:"token keyword"}},[s._v("VALUES")]),s._v("\n\t"),e("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("(")]),e("span",{pre:!0,attrs:{class:"token keyword"}},[s._v("next")]),s._v(" "),e("span",{pre:!0,attrs:{class:"token keyword"}},[s._v("VALUE")]),s._v(" "),e("span",{pre:!0,attrs:{class:"token keyword"}},[s._v("FOR")]),s._v(" MYCATSEQ_GLOBAL"),e("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(",")]),s._v(" "),e("span",{pre:!0,attrs:{class:"token string"}},[s._v('"test"')]),e("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(",")]),s._v(" "),e("span",{pre:!0,attrs:{class:"token number"}},[s._v("411")]),s._v(" "),e("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(")")]),e("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(";")]),s._v("\n")])]),s._v(" "),e("div",{staticClass:"line-numbers-wrapper"},[e("span",{staticClass:"line-number"},[s._v("1")]),e("br"),e("span",{staticClass:"line-number"},[s._v("2")]),e("br"),e("span",{staticClass:"line-number"},[s._v("3")]),e("br")])])])}),[],!1,null,null,null);a.default=r.exports}}]);
(window.webpackJsonp=window.webpackJsonp||[]).push([[69],{486:function(s,t,a){s.exports=a.p+"assets/img/image-20200623225211701.9a32d7f8.png"},682:function(s,t,a){"use strict";a.r(t);var n=a(15),e=Object(n.a)({},(function(){var s=this,t=s.$createElement,n=s._self._c||t;return n("ContentSlotsDistributor",{attrs:{"slot-key":s.$parent.slotKey}},[n("h1",{attrs:{id:"binlog-日志文件的重要性"}},[n("a",{staticClass:"header-anchor",attrs:{href:"#binlog-日志文件的重要性"}},[s._v("#")]),s._v(" Binlog 日志文件的重要性")]),s._v(" "),n("p",[s._v("Replication 集群原理就是利用 Binlog 日志进行同步数据，所以有必要了解。")]),s._v(" "),n("h2",{attrs:{id:"binlog-日志文件"}},[n("a",{staticClass:"header-anchor",attrs:{href:"#binlog-日志文件"}},[s._v("#")]),s._v(" Binlog 日志文件")]),s._v(" "),n("p",[s._v("binlog 日志文件记录了 "),n("strong",[s._v("MySQl 执行的所有操作")]),s._v("，以及 "),n("strong",[s._v("执行 SQL 语句消耗的时间")]),s._v("。")]),s._v(" "),n("p",[s._v("默认情况下是关闭的。")]),s._v(" "),n("h2",{attrs:{id:"开启-binlog-日志"}},[n("a",{staticClass:"header-anchor",attrs:{href:"#开启-binlog-日志"}},[s._v("#")]),s._v(" 开启 binlog 日志")]),s._v(" "),n("p",[s._v("修改 mysql 配置文件，加上 log_bin 参数，重新启动 MySQL 服务")]),s._v(" "),n("div",{staticClass:"language-bash line-numbers-mode"},[n("pre",{pre:!0,attrs:{class:"language-bash"}},[n("code",[n("span",{pre:!0,attrs:{class:"token comment"}},[s._v("## 日志文件名称，可以随意起名")]),s._v("\nlog_bin "),n("span",{pre:!0,attrs:{class:"token operator"}},[s._v("=")]),s._v(" mysql_bin\n")])]),s._v(" "),n("div",{staticClass:"line-numbers-wrapper"},[n("span",{staticClass:"line-number"},[s._v("1")]),n("br"),n("span",{staticClass:"line-number"},[s._v("2")]),n("br")])]),n("p",[s._v("对于文件的切分存储，mysql 会自动做，后面搭建 Replication 集群时再演示。")]),s._v(" "),n("h2",{attrs:{id:"误删除数据的闪回"}},[n("a",{staticClass:"header-anchor",attrs:{href:"#误删除数据的闪回"}},[s._v("#")]),s._v(" 误删除数据的闪回")]),s._v(" "),n("p",[s._v("Binlog 日志文件的重要性作用，这里使用 误删除数据的闪回做例子讲解")]),s._v(" "),n("p",[s._v("执行了错误的 SQL 语句，误删除了记录，即便 "),n("strong",[s._v("事物已经提交")]),s._v("，但是 "),n("strong",[s._v("依然可以找回数据")]),s._v("，但是业务系统必须要停机（不能有新的数据写入）")]),s._v(" "),n("p",[s._v("可以使用 Python 程序从 binlog 日志中提取 SQL 语句，然后找到剔除错误的 SQL 语句，重新执行 binlog 日志中的 SQL 即可")]),s._v(" "),n("h2",{attrs:{id:"误删除数据找回演示"}},[n("a",{staticClass:"header-anchor",attrs:{href:"#误删除数据找回演示"}},[s._v("#")]),s._v(" 误删除数据找回演示")]),s._v(" "),n("p",[s._v("笔者这里不去实操了。只记录下流程")]),s._v(" "),n("p",[s._v("需要一个权限的  binlog 日志，最好就是先把之前的删除掉，重新启动数据库。")]),s._v(" "),n("p",[s._v("然后执行一些插入数据的操作，再删除掉数据，再插入几行。")]),s._v(" "),n("p",[s._v("那么我们就要利用闪回工具找回被删掉的数据，并且新插入的还保留。")]),s._v(" "),n("div",{staticClass:"language-sql line-numbers-mode"},[n("pre",{pre:!0,attrs:{class:"language-sql"}},[n("code",[n("span",{pre:!0,attrs:{class:"token comment"}},[s._v("-- 首先查看 binlogs 的路径")]),s._v("\n"),n("span",{pre:!0,attrs:{class:"token keyword"}},[s._v("SHOW")]),s._v(" MASTER LOGS\n\n"),n("span",{pre:!0,attrs:{class:"token comment"}},[s._v("-- 查询的结果，类似如下的显示")]),s._v("\n"),n("span",{pre:!0,attrs:{class:"token comment"}},[s._v("-- 有多个 bin log 文件")]),s._v("\nLog_name\t\t\t\t\tFile_size\nmysql"),n("span",{pre:!0,attrs:{class:"token operator"}},[s._v("-")]),s._v("bin"),n("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(".")]),n("span",{pre:!0,attrs:{class:"token number"}},[s._v("000001")]),s._v("\t"),n("span",{pre:!0,attrs:{class:"token number"}},[s._v("177")]),s._v("\nmysql"),n("span",{pre:!0,attrs:{class:"token operator"}},[s._v("-")]),s._v("bin"),n("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(".")]),n("span",{pre:!0,attrs:{class:"token number"}},[s._v("000002")]),s._v("\t"),n("span",{pre:!0,attrs:{class:"token number"}},[s._v("2996342")]),s._v("\nmysql"),n("span",{pre:!0,attrs:{class:"token operator"}},[s._v("-")]),s._v("bin"),n("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(".")]),n("span",{pre:!0,attrs:{class:"token number"}},[s._v("000003")]),s._v("\t"),n("span",{pre:!0,attrs:{class:"token number"}},[s._v("734")]),s._v("\n")])]),s._v(" "),n("div",{staticClass:"line-numbers-wrapper"},[n("span",{staticClass:"line-number"},[s._v("1")]),n("br"),n("span",{staticClass:"line-number"},[s._v("2")]),n("br"),n("span",{staticClass:"line-number"},[s._v("3")]),n("br"),n("span",{staticClass:"line-number"},[s._v("4")]),n("br"),n("span",{staticClass:"line-number"},[s._v("5")]),n("br"),n("span",{staticClass:"line-number"},[s._v("6")]),n("br"),n("span",{staticClass:"line-number"},[s._v("7")]),n("br"),n("span",{staticClass:"line-number"},[s._v("8")]),n("br"),n("span",{staticClass:"line-number"},[s._v("9")]),n("br")])]),n("p",[s._v("使用 binlog2sql 工具，找回")]),s._v(" "),n("div",{staticClass:"language-bash line-numbers-mode"},[n("pre",{pre:!0,attrs:{class:"language-bash"}},[n("code",[s._v("python binlog2sql.py \n-uadmin\t-p"),n("span",{pre:!0,attrs:{class:"token string"}},[s._v("'123456'")]),s._v("\t\t\t"),n("span",{pre:!0,attrs:{class:"token comment"}},[s._v("# 用户名与密码")]),s._v("\n-dflash\t\t\t\t\t\t\t\t\t"),n("span",{pre:!0,attrs:{class:"token comment"}},[s._v("# 逻辑库")]),s._v("\n-t student\t\t\t\t\t\t\t"),n("span",{pre:!0,attrs:{class:"token comment"}},[s._v("# 数据表")]),s._v("\n--start-file"),n("span",{pre:!0,attrs:{class:"token operator"}},[s._v("=")]),s._v("‘mysql-bin.000001’\t"),n("span",{pre:!0,attrs:{class:"token comment"}},[s._v("# 日志文件")]),s._v("\n"),n("span",{pre:!0,attrs:{class:"token operator"}},[s._v(">")]),s._v("/home/flash1.sql\t\t\t\t"),n("span",{pre:!0,attrs:{class:"token comment"}},[s._v("# 将解析的 sql 语句输出到哪个文件")]),s._v("\n")])]),s._v(" "),n("div",{staticClass:"line-numbers-wrapper"},[n("span",{staticClass:"line-number"},[s._v("1")]),n("br"),n("span",{staticClass:"line-number"},[s._v("2")]),n("br"),n("span",{staticClass:"line-number"},[s._v("3")]),n("br"),n("span",{staticClass:"line-number"},[s._v("4")]),n("br"),n("span",{staticClass:"line-number"},[s._v("5")]),n("br"),n("span",{staticClass:"line-number"},[s._v("6")]),n("br")])]),n("p",[s._v("这个命令要对多个 binlog 日志进行解析，因为你不确定那些语句被记录在哪个文件上了")]),s._v(" "),n("div",{staticClass:"language-bash line-numbers-mode"},[n("pre",{pre:!0,attrs:{class:"language-bash"}},[n("code",[s._v("python binlog2sql.py  -uadmin\t-p"),n("span",{pre:!0,attrs:{class:"token string"}},[s._v("'123456'")]),s._v(" -dflash -t student\t--start-file"),n("span",{pre:!0,attrs:{class:"token operator"}},[s._v("=")]),s._v("‘mysql-bin.000001’"),n("span",{pre:!0,attrs:{class:"token operator"}},[s._v(">")]),s._v("/home/flash1.sql\n\npython binlog2sql.py  -uadmin\t-p"),n("span",{pre:!0,attrs:{class:"token string"}},[s._v("'123456'")]),s._v(" -dflash -t student\t--start-file"),n("span",{pre:!0,attrs:{class:"token operator"}},[s._v("=")]),s._v("‘mysql-bin.000002’"),n("span",{pre:!0,attrs:{class:"token operator"}},[s._v(">")]),s._v("/home/flash2.sql\n")])]),s._v(" "),n("div",{staticClass:"line-numbers-wrapper"},[n("span",{staticClass:"line-number"},[s._v("1")]),n("br"),n("span",{staticClass:"line-number"},[s._v("2")]),n("br"),n("span",{staticClass:"line-number"},[s._v("3")]),n("br")])]),n("p",[s._v("解析出的 SQL 语句如下图所示")]),s._v(" "),n("p",[n("img",{attrs:{src:a(486),alt:"image-20200623225211701"}})]),s._v(" "),n("p",[s._v("可以看到先插入了 4 条语句，然后更新了 2 条语句，再删除了 4 条语句，再插入了 4 条语句。包括还有创建表的语句。")]),s._v(" "),n("p",[s._v("找回数据就很简单了：将 delete 的那 4 条语句删除，把其他的语句重新执行一次，就找回来了")])])}),[],!1,null,null,null);t.default=e.exports}}]);
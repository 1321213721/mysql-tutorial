(window.webpackJsonp=window.webpackJsonp||[]).push([[34],{316:function(s,t,a){s.exports=a.p+"assets/img/image-20200621211931122.1a5c5c14.png"},481:function(s,t,a){s.exports=a.p+"assets/img/image-20200621213655845.c81761af.png"},482:function(s,t,a){s.exports=a.p+"assets/img/image-20200621225537824.a1a27dd6.png"},691:function(s,t,a){"use strict";a.r(t);var n=a(15),e=Object(n.a)({},(function(){var s=this,t=s.$createElement,n=s._self._c||t;return n("ContentSlotsDistributor",{attrs:{"slot-key":s.$parent.slotKey}},[n("h1",{attrs:{id:"mycat-双机热备方案"}},[n("a",{staticClass:"header-anchor",attrs:{href:"#mycat-双机热备方案"}},[s._v("#")]),s._v(" MyCat 双机热备方案")]),s._v(" "),n("p",[s._v("只有双机热备的 MyCat 方案才具备高可用性。")]),s._v(" "),n("p",[n("img",{attrs:{src:a(316),alt:"image-20200621211931122"}})]),s._v(" "),n("p",[s._v("Keepalived 会去抢占虚拟 IP：")]),s._v(" "),n("ul",[n("li",[s._v("抢占到的成为 Master 节点，同时还会发出广播")]),s._v(" "),n("li",[s._v("Backup 节点接收到广播，表示 Master 还活着")]),s._v(" "),n("li",[s._v("当 Backup 节点接收不到广播的时候，表示 Master 宕机了，开始抢占节点")])]),s._v(" "),n("h2",{attrs:{id:"配置虚拟-ip-的前提条件"}},[n("a",{staticClass:"header-anchor",attrs:{href:"#配置虚拟-ip-的前提条件"}},[s._v("#")]),s._v(" 配置虚拟 IP 的前提条件")]),s._v(" "),n("ul",[n("li",[n("p",[s._v("虚拟 IP 只支持局域网，不可以在公网设置虚拟 IP")])]),s._v(" "),n("li",[n("p",[s._v("云主机无法设置虚拟 IP")])]),s._v(" "),n("li",[n("p",[n("strong",[s._v("只有 Linux 才可以设置虚拟 IP")])]),s._v(" "),n("p",[s._v("windows 和 MacOS 系统无法设置")])]),s._v(" "),n("li",[n("p",[s._v("公司网络与移动热点网络环境下，不能设置虚拟 IP")])])]),s._v(" "),n("h2",{attrs:{id:"正确设置虚拟-ip-的环境"}},[n("a",{staticClass:"header-anchor",attrs:{href:"#正确设置虚拟-ip-的环境"}},[s._v("#")]),s._v(" 正确设置虚拟 IP 的环境")]),s._v(" "),n("ul",[n("li",[s._v("在 VM 虚拟机上面设置桥接网络（必须）")]),s._v(" "),n("li",[s._v("使用家用路由器的网络环境（链接网线最好，WIFI 其次）")])]),s._v(" "),n("h2",{attrs:{id:"keepalived-工作原理"}},[n("a",{staticClass:"header-anchor",attrs:{href:"#keepalived-工作原理"}},[s._v("#")]),s._v(" Keepalived 工作原理")]),s._v(" "),n("p",[s._v("Keepalived 基于 VRRP 协议，可以预防单点故障。")]),s._v(" "),n("p",[s._v("VRRP 协议将多个服务节点组成一个网络，里面有一个 Master 和 若干 Backup 节点。")]),s._v(" "),n("p",[s._v("Master 会发送 VRRP 广播，如果 Backup 节点收不到广播，就认为 Master 节点宕机了。Backup 节点会选举出一个新的 Master 节点，这个选举过程，我们可以进行一定的干预，比如哪些节点优先级高一点，成为 master 的可能性就大一点。")]),s._v(" "),n("h2",{attrs:{id:"让防火墙支持-vrrp-协议"}},[n("a",{staticClass:"header-anchor",attrs:{href:"#让防火墙支持-vrrp-协议"}},[s._v("#")]),s._v(" 让防火墙支持 VRRP 协议")]),s._v(" "),n("p",[s._v("开放防火墙，让 CentOS 支持 VRRP 协议")]),s._v(" "),n("div",{staticClass:"language-bash line-numbers-mode"},[n("pre",{pre:!0,attrs:{class:"language-bash"}},[n("code",[s._v("firewall-cmd --direct --permanent --add-rule ipv4 filter INPUT "),n("span",{pre:!0,attrs:{class:"token number"}},[s._v("0")]),s._v(" \n--in-interface ens33\t\t\t\t"),n("span",{pre:!0,attrs:{class:"token comment"}},[s._v("# 网卡名称")]),s._v("\n--destination "),n("span",{pre:!0,attrs:{class:"token number"}},[s._v("224.0")]),s._v(".0.18\t\t"),n("span",{pre:!0,attrs:{class:"token comment"}},[s._v("# 广播地址，VRRP 协议固定的，不用修改")]),s._v("\n--protocol vrrp -j ACCEPT\n")])]),s._v(" "),n("div",{staticClass:"line-numbers-wrapper"},[n("span",{staticClass:"line-number"},[s._v("1")]),n("br"),n("span",{staticClass:"line-number"},[s._v("2")]),n("br"),n("span",{staticClass:"line-number"},[s._v("3")]),n("br"),n("span",{staticClass:"line-number"},[s._v("4")]),n("br")])]),n("p",[s._v("实际操作练习：")]),s._v(" "),n("div",{staticClass:"language-bash line-numbers-mode"},[n("pre",{pre:!0,attrs:{class:"language-bash"}},[n("code",[n("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("[")]),s._v("root@study volumes"),n("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("]")]),n("span",{pre:!0,attrs:{class:"token comment"}},[s._v("# firewall-cmd --direct --permanent --add-rule ipv4 filter INPUT 0 --in-interface enp0s8 --destination 224.0.0.18 --protocol vrrp -j ACCEPT")]),s._v("\n"),n("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("[")]),s._v("root@study volumes"),n("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("]")]),n("span",{pre:!0,attrs:{class:"token comment"}},[s._v("# firewall-cmd --reload")]),s._v("\n\n"),n("span",{pre:!0,attrs:{class:"token comment"}},[s._v("# 记得还是需要重启 docker 服务")]),s._v("\n")])]),s._v(" "),n("div",{staticClass:"line-numbers-wrapper"},[n("span",{staticClass:"line-number"},[s._v("1")]),n("br"),n("span",{staticClass:"line-number"},[s._v("2")]),n("br"),n("span",{staticClass:"line-number"},[s._v("3")]),n("br"),n("span",{staticClass:"line-number"},[s._v("4")]),n("br")])]),n("h2",{attrs:{id:"虚拟-ip-地址"}},[n("a",{staticClass:"header-anchor",attrs:{href:"#虚拟-ip-地址"}},[s._v("#")]),s._v(" 虚拟 IP 地址")]),s._v(" "),n("p",[s._v("在 Linux 系统中可以在网卡设备中设置多个 IP 地址，已达到为不同程序分配一个独立的 IP 地址，这种 IP 地址被称作虚拟 IP")]),s._v(" "),n("p",[n("img",{attrs:{src:a(481),alt:"image-20200621213655845"}})]),s._v(" "),n("h2",{attrs:{id:"安装-keepalived"}},[n("a",{staticClass:"header-anchor",attrs:{href:"#安装-keepalived"}},[s._v("#")]),s._v(" 安装 Keepalived")]),s._v(" "),n("p",[s._v("进入到 MyCat 容器")]),s._v(" "),n("div",{staticClass:"language-bash line-numbers-mode"},[n("pre",{pre:!0,attrs:{class:"language-bash"}},[n("code",[n("span",{pre:!0,attrs:{class:"token comment"}},[s._v("# 该容器是基于 乌班图 的，软件管理就是用的 apt-get")]),s._v("\n"),n("span",{pre:!0,attrs:{class:"token comment"}},[s._v("# 先更新下")]),s._v("\n"),n("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("[")]),s._v("root@study volumes"),n("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("]")]),n("span",{pre:!0,attrs:{class:"token comment"}},[s._v("# docker exec -it mycat1 bash")]),s._v("\nroot@study:/"),n("span",{pre:!0,attrs:{class:"token comment"}},[s._v("# apt-get update")]),s._v("\nroot@study:/"),n("span",{pre:!0,attrs:{class:"token comment"}},[s._v("# apt-get install keepalived")]),s._v("\n")])]),s._v(" "),n("div",{staticClass:"line-numbers-wrapper"},[n("span",{staticClass:"line-number"},[s._v("1")]),n("br"),n("span",{staticClass:"line-number"},[s._v("2")]),n("br"),n("span",{staticClass:"line-number"},[s._v("3")]),n("br"),n("span",{staticClass:"line-number"},[s._v("4")]),n("br"),n("span",{staticClass:"line-number"},[s._v("5")]),n("br")])]),n("h2",{attrs:{id:"keepalived-配置文件"}},[n("a",{staticClass:"header-anchor",attrs:{href:"#keepalived-配置文件"}},[s._v("#")]),s._v(" keepalived 配置文件")]),s._v(" "),n("p",[s._v("keepalived 的配置文件路径是 "),n("code",[s._v("/etc/keepalived/keepalived.conf")]),s._v("，配置文件内容为")]),s._v(" "),n("div",{staticClass:"language-bash line-numbers-mode"},[n("pre",{pre:!0,attrs:{class:"language-bash"}},[n("code",[s._v("vrrp_instance VI_1 "),n("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("{")]),s._v("\n\tstate MASTER\n\tinterface docker_gwbridge\n\tvirtual_router_id "),n("span",{pre:!0,attrs:{class:"token number"}},[s._v("51")]),s._v("\n\tpriority "),n("span",{pre:!0,attrs:{class:"token number"}},[s._v("100")]),s._v("\n\tadvert_int "),n("span",{pre:!0,attrs:{class:"token number"}},[s._v("1")]),s._v("\n\tauthentication "),n("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("{")]),s._v("\n\t\tauth_type PASS\n\t\tauth_pass "),n("span",{pre:!0,attrs:{class:"token number"}},[s._v("123456")]),s._v("\n\t"),n("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("}")]),s._v("\n\tvirtual_ipaddress "),n("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("{")]),s._v("\n\t\t"),n("span",{pre:!0,attrs:{class:"token number"}},[s._v("172.18")]),s._v(".0.201\n\t"),n("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("}")]),s._v("\n"),n("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("}")]),s._v("\n")])]),s._v(" "),n("div",{staticClass:"line-numbers-wrapper"},[n("span",{staticClass:"line-number"},[s._v("1")]),n("br"),n("span",{staticClass:"line-number"},[s._v("2")]),n("br"),n("span",{staticClass:"line-number"},[s._v("3")]),n("br"),n("span",{staticClass:"line-number"},[s._v("4")]),n("br"),n("span",{staticClass:"line-number"},[s._v("5")]),n("br"),n("span",{staticClass:"line-number"},[s._v("6")]),n("br"),n("span",{staticClass:"line-number"},[s._v("7")]),n("br"),n("span",{staticClass:"line-number"},[s._v("8")]),n("br"),n("span",{staticClass:"line-number"},[s._v("9")]),n("br"),n("span",{staticClass:"line-number"},[s._v("10")]),n("br"),n("span",{staticClass:"line-number"},[s._v("11")]),n("br"),n("span",{staticClass:"line-number"},[s._v("12")]),n("br"),n("span",{staticClass:"line-number"},[s._v("13")]),n("br"),n("span",{staticClass:"line-number"},[s._v("14")]),n("br")])]),n("ul",[n("li",[n("p",[s._v("state：Keepalived 的身份")]),s._v(" "),n("p",[s._v("MASTER 主服务，BACKUP 备服务。主服务要抢占虚拟 IP，备用服务不会抢占 IP。")]),s._v(" "),n("p",[s._v("所以要在诶个 Keepalived 中设置为 MASTER 他们才会抢占 IP")])]),s._v(" "),n("li",[n("p",[s._v("interface：网卡设备")]),s._v(" "),n("p",[s._v("这里绑定的是 "),n("strong",[s._v("docker 容器里的网卡设备")])])]),s._v(" "),n("li",[n("p",[s._v("virtual_router_id：虚拟路由 ID 名字")]),s._v(" "),n("p",[s._v("相同的虚拟路由 ID 才能被编入一组 vrrp 网络中。也就是说类似分组组网的功能。")])]),s._v(" "),n("li",[n("p",[s._v("priority：权重")]),s._v(" "),n("p",[s._v("数值越大，越可能被选举为 Master 节点；")]),s._v(" "),n("p",[s._v("你可以把硬件配置比较好的节点权重设置高一点")])]),s._v(" "),n("li",[n("p",[s._v("advert_int：心跳时间")]),s._v(" "),n("p",[s._v("MASTER 与 BACKUP 节点之间同步检查的时间间隔，单位为秒。"),n("strong",[s._v("主备之间必须一致")])]),s._v(" "),n("p",[s._v("超过该值，MASTER 还没有发送广播，那么 BACKUP 节点就会重新选举 MASTER 了")])]),s._v(" "),n("li",[n("p",[s._v("authentication：主从服务器验证方式")]),s._v(" "),n("p",[n("strong",[s._v("主备必须使用相同")]),s._v(" 的密码才能正常通信")])]),s._v(" "),n("li",[n("p",[s._v("virtual_ipaddress：虚拟 IP 地址")]),s._v(" "),n("p",[s._v("容器是运行在 swarm 网络里面的，所以该地址要设置为 swarm 里面的 IP 地址；")]),s._v(" "),n("p",[s._v("swarm 网段为 172.18.0.x")])])]),s._v(" "),n("p",[s._v("由于我们直接安装的，该程序并没有安装到我们的数据卷中，所以要先给 docker 容器安装 vim 程序，然后使用 vim 程序来编写配置文件")]),s._v(" "),n("div",{staticClass:"language-bash line-numbers-mode"},[n("pre",{pre:!0,attrs:{class:"language-bash"}},[n("code",[s._v("root@study:/"),n("span",{pre:!0,attrs:{class:"token comment"}},[s._v("# apt-get install vim -y")]),s._v("\nroot@study:/"),n("span",{pre:!0,attrs:{class:"token comment"}},[s._v("# vim /etc/keepalived/keepalived.conf")]),s._v("\n"),n("span",{pre:!0,attrs:{class:"token comment"}},[s._v("# 配置内容如下")]),s._v("\nvrrp_instance VI_1 "),n("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("{")]),s._v("\n\tstate MASTER\n\tinterface docker_gwbridge\n\tvirtual_router_id "),n("span",{pre:!0,attrs:{class:"token number"}},[s._v("51")]),s._v("\n\tpriority "),n("span",{pre:!0,attrs:{class:"token number"}},[s._v("100")]),s._v("\n\tadvert_int "),n("span",{pre:!0,attrs:{class:"token number"}},[s._v("1")]),s._v("\n\tauthentication "),n("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("{")]),s._v("\n\t\tauth_type PASS\n\t\tauth_pass "),n("span",{pre:!0,attrs:{class:"token number"}},[s._v("123456")]),s._v("\n\t"),n("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("}")]),s._v("\n\tvirtual_ipaddress "),n("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("{")]),s._v("\n\t\t"),n("span",{pre:!0,attrs:{class:"token number"}},[s._v("172.18")]),s._v(".0.201\n\t"),n("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("}")]),s._v("\n"),n("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("}")]),s._v("\n")])]),s._v(" "),n("div",{staticClass:"line-numbers-wrapper"},[n("span",{staticClass:"line-number"},[s._v("1")]),n("br"),n("span",{staticClass:"line-number"},[s._v("2")]),n("br"),n("span",{staticClass:"line-number"},[s._v("3")]),n("br"),n("span",{staticClass:"line-number"},[s._v("4")]),n("br"),n("span",{staticClass:"line-number"},[s._v("5")]),n("br"),n("span",{staticClass:"line-number"},[s._v("6")]),n("br"),n("span",{staticClass:"line-number"},[s._v("7")]),n("br"),n("span",{staticClass:"line-number"},[s._v("8")]),n("br"),n("span",{staticClass:"line-number"},[s._v("9")]),n("br"),n("span",{staticClass:"line-number"},[s._v("10")]),n("br"),n("span",{staticClass:"line-number"},[s._v("11")]),n("br"),n("span",{staticClass:"line-number"},[s._v("12")]),n("br"),n("span",{staticClass:"line-number"},[s._v("13")]),n("br"),n("span",{staticClass:"line-number"},[s._v("14")]),n("br"),n("span",{staticClass:"line-number"},[s._v("15")]),n("br"),n("span",{staticClass:"line-number"},[s._v("16")]),n("br"),n("span",{staticClass:"line-number"},[s._v("17")]),n("br")])]),n("p",[s._v("启动 keepalived")]),s._v(" "),n("div",{staticClass:"language-bash line-numbers-mode"},[n("pre",{pre:!0,attrs:{class:"language-bash"}},[n("code",[s._v("root@study:/"),n("span",{pre:!0,attrs:{class:"token comment"}},[s._v("# service keepalived start")]),s._v("\n * Starting keepalived keepalived                 "),n("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("[")]),s._v(" OK "),n("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("]")]),s._v("\n")])]),s._v(" "),n("div",{staticClass:"line-numbers-wrapper"},[n("span",{staticClass:"line-number"},[s._v("1")]),n("br"),n("span",{staticClass:"line-number"},[s._v("2")]),n("br")])]),n("p",[s._v("检查是否配置成功")]),s._v(" "),n("div",{staticClass:"language-bash line-numbers-mode"},[n("pre",{pre:!0,attrs:{class:"language-bash"}},[n("code",[n("span",{pre:!0,attrs:{class:"token comment"}},[s._v("# 回到宿主机中，pin 虚拟 IP")]),s._v("\n"),n("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("[")]),s._v("root@study volumes"),n("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("]")]),n("span",{pre:!0,attrs:{class:"token comment"}},[s._v("# ping 172.18.0.201")]),s._v("\nPING "),n("span",{pre:!0,attrs:{class:"token number"}},[s._v("172.18")]),s._v(".0.201 "),n("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("(")]),n("span",{pre:!0,attrs:{class:"token number"}},[s._v("172.18")]),s._v(".0.201"),n("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(")")]),s._v(" "),n("span",{pre:!0,attrs:{class:"token number"}},[s._v("56")]),n("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("(")]),n("span",{pre:!0,attrs:{class:"token number"}},[s._v("84")]),n("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(")")]),s._v(" bytes of data.\n"),n("span",{pre:!0,attrs:{class:"token number"}},[s._v("64")]),s._v(" bytes from "),n("span",{pre:!0,attrs:{class:"token number"}},[s._v("172.18")]),s._v(".0.201: "),n("span",{pre:!0,attrs:{class:"token assign-left variable"}},[s._v("icmp_seq")]),n("span",{pre:!0,attrs:{class:"token operator"}},[s._v("=")]),n("span",{pre:!0,attrs:{class:"token number"}},[s._v("1")]),s._v(" "),n("span",{pre:!0,attrs:{class:"token assign-left variable"}},[s._v("ttl")]),n("span",{pre:!0,attrs:{class:"token operator"}},[s._v("=")]),n("span",{pre:!0,attrs:{class:"token number"}},[s._v("64")]),s._v(" "),n("span",{pre:!0,attrs:{class:"token assign-left variable"}},[s._v("time")]),n("span",{pre:!0,attrs:{class:"token operator"}},[s._v("=")]),n("span",{pre:!0,attrs:{class:"token number"}},[s._v("0.045")]),s._v(" ms\n"),n("span",{pre:!0,attrs:{class:"token number"}},[s._v("64")]),s._v(" bytes from "),n("span",{pre:!0,attrs:{class:"token number"}},[s._v("172.18")]),s._v(".0.201: "),n("span",{pre:!0,attrs:{class:"token assign-left variable"}},[s._v("icmp_seq")]),n("span",{pre:!0,attrs:{class:"token operator"}},[s._v("=")]),n("span",{pre:!0,attrs:{class:"token number"}},[s._v("2")]),s._v(" "),n("span",{pre:!0,attrs:{class:"token assign-left variable"}},[s._v("ttl")]),n("span",{pre:!0,attrs:{class:"token operator"}},[s._v("=")]),n("span",{pre:!0,attrs:{class:"token number"}},[s._v("64")]),s._v(" "),n("span",{pre:!0,attrs:{class:"token assign-left variable"}},[s._v("time")]),n("span",{pre:!0,attrs:{class:"token operator"}},[s._v("=")]),n("span",{pre:!0,attrs:{class:"token number"}},[s._v("0.041")]),s._v(" ms\n"),n("span",{pre:!0,attrs:{class:"token number"}},[s._v("64")]),s._v(" bytes from "),n("span",{pre:!0,attrs:{class:"token number"}},[s._v("172.18")]),s._v(".0.201: "),n("span",{pre:!0,attrs:{class:"token assign-left variable"}},[s._v("icmp_seq")]),n("span",{pre:!0,attrs:{class:"token operator"}},[s._v("=")]),n("span",{pre:!0,attrs:{class:"token number"}},[s._v("3")]),s._v(" "),n("span",{pre:!0,attrs:{class:"token assign-left variable"}},[s._v("ttl")]),n("span",{pre:!0,attrs:{class:"token operator"}},[s._v("=")]),n("span",{pre:!0,attrs:{class:"token number"}},[s._v("64")]),s._v(" "),n("span",{pre:!0,attrs:{class:"token assign-left variable"}},[s._v("time")]),n("span",{pre:!0,attrs:{class:"token operator"}},[s._v("=")]),n("span",{pre:!0,attrs:{class:"token number"}},[s._v("0.045")]),s._v(" ms\n"),n("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("..")]),s._v(".\n")])]),s._v(" "),n("div",{staticClass:"line-numbers-wrapper"},[n("span",{staticClass:"line-number"},[s._v("1")]),n("br"),n("span",{staticClass:"line-number"},[s._v("2")]),n("br"),n("span",{staticClass:"line-number"},[s._v("3")]),n("br"),n("span",{staticClass:"line-number"},[s._v("4")]),n("br"),n("span",{staticClass:"line-number"},[s._v("5")]),n("br"),n("span",{staticClass:"line-number"},[s._v("6")]),n("br"),n("span",{staticClass:"line-number"},[s._v("7")]),n("br")])]),n("h2",{attrs:{id:"搭建另外一个-mycat-容器"}},[n("a",{staticClass:"header-anchor",attrs:{href:"#搭建另外一个-mycat-容器"}},[s._v("#")]),s._v(" 搭建另外一个 MyCat 容器")]),s._v(" "),n("p",[n("img",{attrs:{src:a(316),alt:"image-20200621211931122"}})]),s._v(" "),n("p",[s._v("双机热备 MyCat 方案由于需要两个 MyCat 容器，所以还需要挑选一台宿主机去安装 MyCat 容器，并且安装好 Keepalived")]),s._v(" "),n("p",[s._v("这里说些安装步骤：")]),s._v(" "),n("ol",[n("li",[s._v("先配置 Keepalived VRRP 防火墙协议")]),s._v(" "),n("li",[s._v("重启 docker 服务")]),s._v(" "),n("li",[s._v("然后创建 MyCat 容器")]),s._v(" "),n("li",[s._v("把第一个 MyCat 容器数据卷中的 MyCat 文件复制一份到第二个 Mycat 容器中")])]),s._v(" "),n("p",[s._v("笔者这里使用 192.168.56.107 这台虚拟机实例来安装；")]),s._v(" "),n("div",{staticClass:"language-bash line-numbers-mode"},[n("pre",{pre:!0,attrs:{class:"language-bash"}},[n("code",[n("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("[")]),s._v("root@study ~"),n("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("]")]),n("span",{pre:!0,attrs:{class:"token comment"}},[s._v("# firewall-cmd --direct --permanent --add-rule ipv4 filter INPUT 0 --in-interface enp0s8 --destination 224.0.0.18 --protocol vrrp -j ")]),s._v("\n"),n("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("[")]),s._v("root@study ~"),n("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("]")]),n("span",{pre:!0,attrs:{class:"token comment"}},[s._v("# firewall-cmd --reload")]),s._v("\n\n"),n("span",{pre:!0,attrs:{class:"token comment"}},[s._v("# 重启 docker 服务")]),s._v("\n"),n("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("[")]),s._v("root@study ~"),n("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("]")]),n("span",{pre:!0,attrs:{class:"token comment"}},[s._v("# systemctl restart docker")]),s._v("\n\n"),n("span",{pre:!0,attrs:{class:"token comment"}},[s._v("# 恢复启动原来的数据源集群容器")]),s._v("\n"),n("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("[")]),s._v("root@study ~"),n("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("]")]),n("span",{pre:!0,attrs:{class:"token comment"}},[s._v("# docker start rn5")]),s._v("\n"),n("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("[")]),s._v("root@study ~"),n("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("]")]),n("span",{pre:!0,attrs:{class:"token comment"}},[s._v("# docker start rn2")]),s._v("\n"),n("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("[")]),s._v("root@study ~"),n("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("]")]),n("span",{pre:!0,attrs:{class:"token comment"}},[s._v("# docker start pn5")]),s._v("\n"),n("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("[")]),s._v("root@study ~"),n("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("]")]),n("span",{pre:!0,attrs:{class:"token comment"}},[s._v("# docker start pn2")]),s._v("\n\n"),n("span",{pre:!0,attrs:{class:"token comment"}},[s._v("# 创建 MyCat 容器")]),s._v("\n"),n("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("[")]),s._v("root@study ~"),n("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("]")]),n("span",{pre:!0,attrs:{class:"token comment"}},[s._v("# docker run -d -it --name mycat2 -v mycat2:/root/server --privileged --net=host openjdk8")]),s._v("\n"),n("span",{pre:!0,attrs:{class:"token comment"}},[s._v("# 进入到该容器数据卷中")]),s._v("\n"),n("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("[")]),s._v("root@study ~"),n("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("]")]),n("span",{pre:!0,attrs:{class:"token comment"}},[s._v("# docker volume inspect mycat2")]),s._v("\n"),n("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("[")]),s._v("\n    "),n("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("{")]),s._v("\n        "),n("span",{pre:!0,attrs:{class:"token string"}},[s._v('"Driver"')]),n("span",{pre:!0,attrs:{class:"token builtin class-name"}},[s._v(":")]),s._v(" "),n("span",{pre:!0,attrs:{class:"token string"}},[s._v('"local"')]),s._v(",\n        "),n("span",{pre:!0,attrs:{class:"token string"}},[s._v('"Labels"')]),n("span",{pre:!0,attrs:{class:"token builtin class-name"}},[s._v(":")]),s._v(" null,\n        "),n("span",{pre:!0,attrs:{class:"token string"}},[s._v('"Mountpoint"')]),n("span",{pre:!0,attrs:{class:"token builtin class-name"}},[s._v(":")]),s._v(" "),n("span",{pre:!0,attrs:{class:"token string"}},[s._v('"/var/lib/docker/volumes/mycat2/_data"')]),s._v(",\n        "),n("span",{pre:!0,attrs:{class:"token string"}},[s._v('"Name"')]),n("span",{pre:!0,attrs:{class:"token builtin class-name"}},[s._v(":")]),s._v(" "),n("span",{pre:!0,attrs:{class:"token string"}},[s._v('"mycat2"')]),s._v(",\n        "),n("span",{pre:!0,attrs:{class:"token string"}},[s._v('"Options"')]),n("span",{pre:!0,attrs:{class:"token builtin class-name"}},[s._v(":")]),s._v(" "),n("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("{")]),n("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("}")]),s._v(",\n        "),n("span",{pre:!0,attrs:{class:"token string"}},[s._v('"Scope"')]),n("span",{pre:!0,attrs:{class:"token builtin class-name"}},[s._v(":")]),s._v(" "),n("span",{pre:!0,attrs:{class:"token string"}},[s._v('"local"')]),s._v("\n    "),n("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("}")]),s._v("\n"),n("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("]")]),s._v("\n"),n("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("[")]),s._v("root@study ~"),n("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("]")]),n("span",{pre:!0,attrs:{class:"token comment"}},[s._v("# cd /var/lib/docker/volumes/mycat2/_data")]),s._v("\n\n"),n("span",{pre:!0,attrs:{class:"token comment"}},[s._v("# 在 mycat1 容器上，通过 ssh 复制 mycat 目录到该数据卷下")]),s._v("\n"),n("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("[")]),s._v("root@study _data"),n("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("]")]),n("span",{pre:!0,attrs:{class:"token comment"}},[s._v("# scp -r mycat/ root@192.168.56.107:/var/lib/docker/volumes/mycat2/_data")]),s._v("\n\n"),n("span",{pre:!0,attrs:{class:"token comment"}},[s._v("# 回到 mycat2 容器上，并进入容器，启动 mycat")]),s._v("\n"),n("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("[")]),s._v("root@study _data"),n("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("]")]),n("span",{pre:!0,attrs:{class:"token comment"}},[s._v("# docker exec -it mycat2 bash")]),s._v("\nroot@study:/"),n("span",{pre:!0,attrs:{class:"token comment"}},[s._v("# cd /root/server/mycat/bin/")]),s._v("\nroot@study:~/server/mycat/bin"),n("span",{pre:!0,attrs:{class:"token comment"}},[s._v("# ./startup_nowrap.sh")]),s._v("\n")])]),s._v(" "),n("div",{staticClass:"line-numbers-wrapper"},[n("span",{staticClass:"line-number"},[s._v("1")]),n("br"),n("span",{staticClass:"line-number"},[s._v("2")]),n("br"),n("span",{staticClass:"line-number"},[s._v("3")]),n("br"),n("span",{staticClass:"line-number"},[s._v("4")]),n("br"),n("span",{staticClass:"line-number"},[s._v("5")]),n("br"),n("span",{staticClass:"line-number"},[s._v("6")]),n("br"),n("span",{staticClass:"line-number"},[s._v("7")]),n("br"),n("span",{staticClass:"line-number"},[s._v("8")]),n("br"),n("span",{staticClass:"line-number"},[s._v("9")]),n("br"),n("span",{staticClass:"line-number"},[s._v("10")]),n("br"),n("span",{staticClass:"line-number"},[s._v("11")]),n("br"),n("span",{staticClass:"line-number"},[s._v("12")]),n("br"),n("span",{staticClass:"line-number"},[s._v("13")]),n("br"),n("span",{staticClass:"line-number"},[s._v("14")]),n("br"),n("span",{staticClass:"line-number"},[s._v("15")]),n("br"),n("span",{staticClass:"line-number"},[s._v("16")]),n("br"),n("span",{staticClass:"line-number"},[s._v("17")]),n("br"),n("span",{staticClass:"line-number"},[s._v("18")]),n("br"),n("span",{staticClass:"line-number"},[s._v("19")]),n("br"),n("span",{staticClass:"line-number"},[s._v("20")]),n("br"),n("span",{staticClass:"line-number"},[s._v("21")]),n("br"),n("span",{staticClass:"line-number"},[s._v("22")]),n("br"),n("span",{staticClass:"line-number"},[s._v("23")]),n("br"),n("span",{staticClass:"line-number"},[s._v("24")]),n("br"),n("span",{staticClass:"line-number"},[s._v("25")]),n("br"),n("span",{staticClass:"line-number"},[s._v("26")]),n("br"),n("span",{staticClass:"line-number"},[s._v("27")]),n("br"),n("span",{staticClass:"line-number"},[s._v("28")]),n("br"),n("span",{staticClass:"line-number"},[s._v("29")]),n("br"),n("span",{staticClass:"line-number"},[s._v("30")]),n("br"),n("span",{staticClass:"line-number"},[s._v("31")]),n("br"),n("span",{staticClass:"line-number"},[s._v("32")]),n("br"),n("span",{staticClass:"line-number"},[s._v("33")]),n("br"),n("span",{staticClass:"line-number"},[s._v("34")]),n("br"),n("span",{staticClass:"line-number"},[s._v("35")]),n("br")])]),n("p",[s._v("第二个 MyCat 容器也安装好了。需要通过 Navicat 验证下 mycat2 是否可以使用；")]),s._v(" "),n("p",[s._v("安装并配置 Keepalived")]),s._v(" "),n("div",{staticClass:"language-bash line-numbers-mode"},[n("pre",{pre:!0,attrs:{class:"language-bash"}},[n("code",[s._v("root@study:/"),n("span",{pre:!0,attrs:{class:"token comment"}},[s._v("# apt-get update")]),s._v("\nroot@study:/"),n("span",{pre:!0,attrs:{class:"token comment"}},[s._v("# apt-get install keepalived -y")]),s._v("\nroot@study:/"),n("span",{pre:!0,attrs:{class:"token comment"}},[s._v("# apt-get install vim -y")]),s._v("\nroot@study:/"),n("span",{pre:!0,attrs:{class:"token comment"}},[s._v("# vim /etc/keepalived/keepalived.conf")]),s._v("\n"),n("span",{pre:!0,attrs:{class:"token comment"}},[s._v("# 配置内容如下")]),s._v("\nvrrp_instance VI_1 "),n("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("{")]),s._v("\n\tstate MASTER\n\tinterface docker_gwbridge\n\tvirtual_router_id "),n("span",{pre:!0,attrs:{class:"token number"}},[s._v("51")]),s._v("\n\tpriority "),n("span",{pre:!0,attrs:{class:"token number"}},[s._v("100")]),s._v("\n\tadvert_int "),n("span",{pre:!0,attrs:{class:"token number"}},[s._v("1")]),s._v("\n\tauthentication "),n("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("{")]),s._v("\n\t\tauth_type PASS\n\t\tauth_pass "),n("span",{pre:!0,attrs:{class:"token number"}},[s._v("123456")]),s._v("\n\t"),n("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("}")]),s._v("\n\tvirtual_ipaddress "),n("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("{")]),s._v("\n\t\t"),n("span",{pre:!0,attrs:{class:"token number"}},[s._v("172.18")]),s._v(".0.201\n\t"),n("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("}")]),s._v("\n"),n("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("}")]),s._v("\nroot@study:/"),n("span",{pre:!0,attrs:{class:"token comment"}},[s._v("# service keepalived start")]),s._v("\n * Starting keepalived keepalived                 "),n("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("[")]),s._v(" OK "),n("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("]")]),s._v("\n")])]),s._v(" "),n("div",{staticClass:"line-numbers-wrapper"},[n("span",{staticClass:"line-number"},[s._v("1")]),n("br"),n("span",{staticClass:"line-number"},[s._v("2")]),n("br"),n("span",{staticClass:"line-number"},[s._v("3")]),n("br"),n("span",{staticClass:"line-number"},[s._v("4")]),n("br"),n("span",{staticClass:"line-number"},[s._v("5")]),n("br"),n("span",{staticClass:"line-number"},[s._v("6")]),n("br"),n("span",{staticClass:"line-number"},[s._v("7")]),n("br"),n("span",{staticClass:"line-number"},[s._v("8")]),n("br"),n("span",{staticClass:"line-number"},[s._v("9")]),n("br"),n("span",{staticClass:"line-number"},[s._v("10")]),n("br"),n("span",{staticClass:"line-number"},[s._v("11")]),n("br"),n("span",{staticClass:"line-number"},[s._v("12")]),n("br"),n("span",{staticClass:"line-number"},[s._v("13")]),n("br"),n("span",{staticClass:"line-number"},[s._v("14")]),n("br"),n("span",{staticClass:"line-number"},[s._v("15")]),n("br"),n("span",{staticClass:"line-number"},[s._v("16")]),n("br"),n("span",{staticClass:"line-number"},[s._v("17")]),n("br"),n("span",{staticClass:"line-number"},[s._v("18")]),n("br"),n("span",{staticClass:"line-number"},[s._v("19")]),n("br"),n("span",{staticClass:"line-number"},[s._v("20")]),n("br"),n("span",{staticClass:"line-number"},[s._v("21")]),n("br")])]),n("h2",{attrs:{id:"测试双机热备"}},[n("a",{staticClass:"header-anchor",attrs:{href:"#测试双机热备"}},[s._v("#")]),s._v(" 测试双机热备")]),s._v(" "),n("p",[s._v("两个 MyCat 容器和 Keepalived 都安装配置启动后，可以使用如下的方式来测试，是否有效")]),s._v(" "),n("ol",[n("li",[s._v("随意停掉一个 mycat 容器")]),s._v(" "),n("li",[s._v("再 "),n("code",[s._v("ping 172.18.0.201")]),s._v(" 是否能 ping 通")]),s._v(" "),n("li",[s._v("再停掉一个 mycat 容器")]),s._v(" "),n("li",[s._v("再 "),n("code",[s._v("ping 172.18.0.201")]),s._v(" 是否能 ping 通")])]),s._v(" "),n("p",[s._v("尴尬的是，笔者这里关完都能访问.")]),s._v(" "),n("h2",{attrs:{id:"如何访问虚拟-ip"}},[n("a",{staticClass:"header-anchor",attrs:{href:"#如何访问虚拟-ip"}},[s._v("#")]),s._v(" 如何访问虚拟 IP")]),s._v(" "),n("p",[s._v("现在在宿主机上可以访问虚拟 IP（因为有 docker_gwbridge 的原因），在非虚拟机上如何访问到虚拟机中的虚拟 IP？")]),s._v(" "),n("p",[s._v("Swarm 网络内的虚拟 IP 无法被外网访问，所以需要把虚拟 IP 映射到外网：")]),s._v(" "),n("p",[n("img",{attrs:{src:a(482),alt:"image-20200621225537824"}})]),s._v(" "),n("p",[s._v("原理就如上：要在宿主机中安装 Keepalived，也可以把 2 台宿主机做成一个主备 Keepalived 方案，达成宿主机的高可用")]),s._v(" "),n("h3",{attrs:{id:"第一个虚拟机-keepalived-安装配置"}},[n("a",{staticClass:"header-anchor",attrs:{href:"#第一个虚拟机-keepalived-安装配置"}},[s._v("#")]),s._v(" 第一个虚拟机 Keepalived 安装配置")]),s._v(" "),n("div",{staticClass:"language-bash line-numbers-mode"},[n("pre",{pre:!0,attrs:{class:"language-bash"}},[n("code",[n("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("[")]),s._v("root@study ~"),n("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("]")]),n("span",{pre:!0,attrs:{class:"token comment"}},[s._v("# yum install keepalived -y")]),s._v("\n\n"),n("span",{pre:!0,attrs:{class:"token comment"}},[s._v("# 该文件中有一些默认内容，可以全部删除")]),s._v("\n"),n("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("[")]),s._v("root@study ~"),n("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("]")]),n("span",{pre:!0,attrs:{class:"token comment"}},[s._v("# vim /etc/keepalived/keepalived.conf")]),s._v("\n"),n("span",{pre:!0,attrs:{class:"token comment"}},[s._v("# 配置内容如下")]),s._v("\nvrrp_instance VI_1 "),n("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("{")]),s._v("\n\tstate MASTER\n\tinterface enp0s8\t\t\t"),n("span",{pre:!0,attrs:{class:"token comment"}},[s._v("# 宿主机的网卡")]),s._v("\n\tvirtual_router_id "),n("span",{pre:!0,attrs:{class:"token number"}},[s._v("61")]),s._v("\n\tpriority "),n("span",{pre:!0,attrs:{class:"token number"}},[s._v("100")]),s._v("\n\tadvert_int "),n("span",{pre:!0,attrs:{class:"token number"}},[s._v("1")]),s._v("\n\tauthentication "),n("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("{")]),s._v("\n\t\tauth_type PASS\n\t\tauth_pass "),n("span",{pre:!0,attrs:{class:"token number"}},[s._v("1111")]),s._v("\n\t"),n("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("}")]),s._v("\n\tvirtual_ipaddress "),n("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("{")]),s._v("\n\t\t"),n("span",{pre:!0,attrs:{class:"token number"}},[s._v("192.168")]),s._v(".56.200\t\t"),n("span",{pre:!0,attrs:{class:"token comment"}},[s._v("# 局域网中一个没有被使用的 IP 作为虚拟 IP")]),s._v("\n\t"),n("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("}")]),s._v("\n"),n("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("}")]),s._v("\n\nvirtual_server "),n("span",{pre:!0,attrs:{class:"token number"}},[s._v("192.168")]),s._v(".56.105 "),n("span",{pre:!0,attrs:{class:"token number"}},[s._v("8066")]),n("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("{")]),s._v("\n\tdelay_loop "),n("span",{pre:!0,attrs:{class:"token number"}},[s._v("3")]),s._v("\n\tlb_algo rr\n\tlb_kind NAT\n\tpersistence "),n("span",{pre:!0,attrs:{class:"token function"}},[s._v("timeout")]),s._v(" "),n("span",{pre:!0,attrs:{class:"token number"}},[s._v("50")]),s._v("\n\tprotocol TCP\n\treal_server "),n("span",{pre:!0,attrs:{class:"token number"}},[s._v("172.18")]),s._v(".0.201 "),n("span",{pre:!0,attrs:{class:"token number"}},[s._v("8066")]),n("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("{")]),s._v("\n\t  weight "),n("span",{pre:!0,attrs:{class:"token number"}},[s._v("1")]),s._v("\n\t"),n("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("}")]),s._v("\n"),n("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("}")]),s._v("\n\nvirtual_server "),n("span",{pre:!0,attrs:{class:"token number"}},[s._v("192.168")]),s._v(".56.105 "),n("span",{pre:!0,attrs:{class:"token number"}},[s._v("9066")]),n("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("{")]),s._v("\n\tdelay_loop "),n("span",{pre:!0,attrs:{class:"token number"}},[s._v("3")]),s._v("\n\tlb_algo rr\n\tlb_kind NAT\n\tpersistence "),n("span",{pre:!0,attrs:{class:"token function"}},[s._v("timeout")]),s._v(" "),n("span",{pre:!0,attrs:{class:"token number"}},[s._v("50")]),s._v("\n\tprotocol TCP\n\treal_server "),n("span",{pre:!0,attrs:{class:"token number"}},[s._v("172.18")]),s._v(".0.201 "),n("span",{pre:!0,attrs:{class:"token number"}},[s._v("9066")]),n("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("{")]),s._v("\n\t  weight "),n("span",{pre:!0,attrs:{class:"token number"}},[s._v("1")]),s._v("\n\t"),n("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("}")]),s._v("\n"),n("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("}")]),s._v("\n")])]),s._v(" "),n("div",{staticClass:"line-numbers-wrapper"},[n("span",{staticClass:"line-number"},[s._v("1")]),n("br"),n("span",{staticClass:"line-number"},[s._v("2")]),n("br"),n("span",{staticClass:"line-number"},[s._v("3")]),n("br"),n("span",{staticClass:"line-number"},[s._v("4")]),n("br"),n("span",{staticClass:"line-number"},[s._v("5")]),n("br"),n("span",{staticClass:"line-number"},[s._v("6")]),n("br"),n("span",{staticClass:"line-number"},[s._v("7")]),n("br"),n("span",{staticClass:"line-number"},[s._v("8")]),n("br"),n("span",{staticClass:"line-number"},[s._v("9")]),n("br"),n("span",{staticClass:"line-number"},[s._v("10")]),n("br"),n("span",{staticClass:"line-number"},[s._v("11")]),n("br"),n("span",{staticClass:"line-number"},[s._v("12")]),n("br"),n("span",{staticClass:"line-number"},[s._v("13")]),n("br"),n("span",{staticClass:"line-number"},[s._v("14")]),n("br"),n("span",{staticClass:"line-number"},[s._v("15")]),n("br"),n("span",{staticClass:"line-number"},[s._v("16")]),n("br"),n("span",{staticClass:"line-number"},[s._v("17")]),n("br"),n("span",{staticClass:"line-number"},[s._v("18")]),n("br"),n("span",{staticClass:"line-number"},[s._v("19")]),n("br"),n("span",{staticClass:"line-number"},[s._v("20")]),n("br"),n("span",{staticClass:"line-number"},[s._v("21")]),n("br"),n("span",{staticClass:"line-number"},[s._v("22")]),n("br"),n("span",{staticClass:"line-number"},[s._v("23")]),n("br"),n("span",{staticClass:"line-number"},[s._v("24")]),n("br"),n("span",{staticClass:"line-number"},[s._v("25")]),n("br"),n("span",{staticClass:"line-number"},[s._v("26")]),n("br"),n("span",{staticClass:"line-number"},[s._v("27")]),n("br"),n("span",{staticClass:"line-number"},[s._v("28")]),n("br"),n("span",{staticClass:"line-number"},[s._v("29")]),n("br"),n("span",{staticClass:"line-number"},[s._v("30")]),n("br"),n("span",{staticClass:"line-number"},[s._v("31")]),n("br"),n("span",{staticClass:"line-number"},[s._v("32")]),n("br"),n("span",{staticClass:"line-number"},[s._v("33")]),n("br"),n("span",{staticClass:"line-number"},[s._v("34")]),n("br"),n("span",{staticClass:"line-number"},[s._v("35")]),n("br"),n("span",{staticClass:"line-number"},[s._v("36")]),n("br"),n("span",{staticClass:"line-number"},[s._v("37")]),n("br"),n("span",{staticClass:"line-number"},[s._v("38")]),n("br"),n("span",{staticClass:"line-number"},[s._v("39")]),n("br"),n("span",{staticClass:"line-number"},[s._v("40")]),n("br"),n("span",{staticClass:"line-number"},[s._v("41")]),n("br")])]),n("ul",[n("li",[s._v("delay_loop：心跳检测，单位秒")]),s._v(" "),n("li",[s._v("lb_algo： rr 为轮询模式")]),s._v(" "),n("li",[s._v("lb_kind： NAT 为 NAT 模式")]),s._v(" "),n("li",[s._v("persistence timeout：超时")]),s._v(" "),n("li",[s._v("real_server：虚拟 IP 接收到请求之后，转发的 IP；该参数很重要")])]),s._v(" "),n("p",[s._v("启动 Keepalived")]),s._v(" "),n("div",{staticClass:"language-bash line-numbers-mode"},[n("pre",{pre:!0,attrs:{class:"language-bash"}},[n("code",[n("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("[")]),s._v("root@study mycat"),n("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("]")]),n("span",{pre:!0,attrs:{class:"token comment"}},[s._v("# service keepalived start")]),s._v("\nRedirecting to /bin/systemctl start keepalived.service\n\n"),n("span",{pre:!0,attrs:{class:"token comment"}},[s._v("# pin 这个虚拟 IP 是否可用")]),s._v("\n"),n("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("[")]),s._v("root@study mycat"),n("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("]")]),n("span",{pre:!0,attrs:{class:"token comment"}},[s._v("# ping 192.168.56.200")]),s._v("\nPING "),n("span",{pre:!0,attrs:{class:"token number"}},[s._v("192.168")]),s._v(".56.200 "),n("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("(")]),n("span",{pre:!0,attrs:{class:"token number"}},[s._v("192.168")]),s._v(".56.200"),n("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(")")]),s._v(" "),n("span",{pre:!0,attrs:{class:"token number"}},[s._v("56")]),n("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("(")]),n("span",{pre:!0,attrs:{class:"token number"}},[s._v("84")]),n("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(")")]),s._v(" bytes of data.\n"),n("span",{pre:!0,attrs:{class:"token number"}},[s._v("64")]),s._v(" bytes from "),n("span",{pre:!0,attrs:{class:"token number"}},[s._v("192.168")]),s._v(".56.200: "),n("span",{pre:!0,attrs:{class:"token assign-left variable"}},[s._v("icmp_seq")]),n("span",{pre:!0,attrs:{class:"token operator"}},[s._v("=")]),n("span",{pre:!0,attrs:{class:"token number"}},[s._v("1")]),s._v(" "),n("span",{pre:!0,attrs:{class:"token assign-left variable"}},[s._v("ttl")]),n("span",{pre:!0,attrs:{class:"token operator"}},[s._v("=")]),n("span",{pre:!0,attrs:{class:"token number"}},[s._v("64")]),s._v(" "),n("span",{pre:!0,attrs:{class:"token assign-left variable"}},[s._v("time")]),n("span",{pre:!0,attrs:{class:"token operator"}},[s._v("=")]),n("span",{pre:!0,attrs:{class:"token number"}},[s._v("0.051")]),s._v(" ms\n"),n("span",{pre:!0,attrs:{class:"token number"}},[s._v("64")]),s._v(" bytes from "),n("span",{pre:!0,attrs:{class:"token number"}},[s._v("192.168")]),s._v(".56.200: "),n("span",{pre:!0,attrs:{class:"token assign-left variable"}},[s._v("icmp_seq")]),n("span",{pre:!0,attrs:{class:"token operator"}},[s._v("=")]),n("span",{pre:!0,attrs:{class:"token number"}},[s._v("2")]),s._v(" "),n("span",{pre:!0,attrs:{class:"token assign-left variable"}},[s._v("ttl")]),n("span",{pre:!0,attrs:{class:"token operator"}},[s._v("=")]),n("span",{pre:!0,attrs:{class:"token number"}},[s._v("64")]),s._v(" "),n("span",{pre:!0,attrs:{class:"token assign-left variable"}},[s._v("time")]),n("span",{pre:!0,attrs:{class:"token operator"}},[s._v("=")]),n("span",{pre:!0,attrs:{class:"token number"}},[s._v("0.044")]),s._v(" ms\n"),n("span",{pre:!0,attrs:{class:"token number"}},[s._v("64")]),s._v(" bytes from "),n("span",{pre:!0,attrs:{class:"token number"}},[s._v("192.168")]),s._v(".56.200: "),n("span",{pre:!0,attrs:{class:"token assign-left variable"}},[s._v("icmp_seq")]),n("span",{pre:!0,attrs:{class:"token operator"}},[s._v("=")]),n("span",{pre:!0,attrs:{class:"token number"}},[s._v("3")]),s._v(" "),n("span",{pre:!0,attrs:{class:"token assign-left variable"}},[s._v("ttl")]),n("span",{pre:!0,attrs:{class:"token operator"}},[s._v("=")]),n("span",{pre:!0,attrs:{class:"token number"}},[s._v("64")]),s._v(" "),n("span",{pre:!0,attrs:{class:"token assign-left variable"}},[s._v("time")]),n("span",{pre:!0,attrs:{class:"token operator"}},[s._v("=")]),n("span",{pre:!0,attrs:{class:"token number"}},[s._v("0.044")]),s._v(" ms\n"),n("span",{pre:!0,attrs:{class:"token number"}},[s._v("64")]),s._v(" bytes from "),n("span",{pre:!0,attrs:{class:"token number"}},[s._v("192.168")]),s._v(".56.200: "),n("span",{pre:!0,attrs:{class:"token assign-left variable"}},[s._v("icmp_seq")]),n("span",{pre:!0,attrs:{class:"token operator"}},[s._v("=")]),n("span",{pre:!0,attrs:{class:"token number"}},[s._v("4")]),s._v(" "),n("span",{pre:!0,attrs:{class:"token assign-left variable"}},[s._v("ttl")]),n("span",{pre:!0,attrs:{class:"token operator"}},[s._v("=")]),n("span",{pre:!0,attrs:{class:"token number"}},[s._v("64")]),s._v(" "),n("span",{pre:!0,attrs:{class:"token assign-left variable"}},[s._v("time")]),n("span",{pre:!0,attrs:{class:"token operator"}},[s._v("=")]),n("span",{pre:!0,attrs:{class:"token number"}},[s._v("0.059")]),s._v(" ms\n"),n("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("..")]),s._v(".\n")])]),s._v(" "),n("div",{staticClass:"line-numbers-wrapper"},[n("span",{staticClass:"line-number"},[s._v("1")]),n("br"),n("span",{staticClass:"line-number"},[s._v("2")]),n("br"),n("span",{staticClass:"line-number"},[s._v("3")]),n("br"),n("span",{staticClass:"line-number"},[s._v("4")]),n("br"),n("span",{staticClass:"line-number"},[s._v("5")]),n("br"),n("span",{staticClass:"line-number"},[s._v("6")]),n("br"),n("span",{staticClass:"line-number"},[s._v("7")]),n("br"),n("span",{staticClass:"line-number"},[s._v("8")]),n("br"),n("span",{staticClass:"line-number"},[s._v("9")]),n("br"),n("span",{staticClass:"line-number"},[s._v("10")]),n("br"),n("span",{staticClass:"line-number"},[s._v("11")]),n("br")])]),n("p",[s._v("通过 Navicat 链接：")]),s._v(" "),n("ul",[n("li",[s._v("ip：192.168.56.200")]),s._v(" "),n("li",[s._v("端口：8066")])]),s._v(" "),n("p",[s._v("前面说到 mycat 容器都关掉了，虚拟 IP 还是可以 ping  通，但是访问不到 mycat 服务。笔者重启了 mycat1 容器包括里面的 mycat 和 Keepalived 服务后，就可以通过 Navicat 链接到虚拟机宿主机上的虚拟 IP 了；")]),s._v(" "),n("h3",{attrs:{id:"第二个虚拟机-keepalived-安装配置"}},[n("a",{staticClass:"header-anchor",attrs:{href:"#第二个虚拟机-keepalived-安装配置"}},[s._v("#")]),s._v(" 第二个虚拟机 Keepalived 安装配置")]),s._v(" "),n("p",[s._v("那么还需要配置第二个虚拟机宿主机上的 Keepalived 程序。配置文件和上面的一样。有一点点不一样， 这里转发的 IP 是自己的 docker 容器上的 IP")]),s._v(" "),n("div",{staticClass:"language-bash line-numbers-mode"},[n("pre",{pre:!0,attrs:{class:"language-bash"}},[n("code",[s._v("vrrp_instance VI_1 "),n("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("{")]),s._v("\n\tstate MASTER\n\tinterface enp0s8\t\t\t"),n("span",{pre:!0,attrs:{class:"token comment"}},[s._v("# 宿主机的网卡")]),s._v("\n\tvirtual_router_id "),n("span",{pre:!0,attrs:{class:"token number"}},[s._v("61")]),s._v("\n\tpriority "),n("span",{pre:!0,attrs:{class:"token number"}},[s._v("100")]),s._v("\n\tadvert_int "),n("span",{pre:!0,attrs:{class:"token number"}},[s._v("1")]),s._v("\n\tauthentication "),n("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("{")]),s._v("\n\t\tauth_type PASS\n\t\tauth_pass "),n("span",{pre:!0,attrs:{class:"token number"}},[s._v("1111")]),s._v("\n\t"),n("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("}")]),s._v("\n\tvirtual_ipaddress "),n("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("{")]),s._v("\n\t\t"),n("span",{pre:!0,attrs:{class:"token number"}},[s._v("192.168")]),s._v(".56.200\t\t"),n("span",{pre:!0,attrs:{class:"token comment"}},[s._v("# 局域网中一个没有被使用的 IP 作为虚拟 IP")]),s._v("\n\t"),n("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("}")]),s._v("\n"),n("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("}")]),s._v("\n"),n("span",{pre:!0,attrs:{class:"token comment"}},[s._v("# 这里转发的 IP 是自己的 docker 容器上的 IP")]),s._v("\nvirtual_server "),n("span",{pre:!0,attrs:{class:"token number"}},[s._v("192.168")]),s._v(".56.107 "),n("span",{pre:!0,attrs:{class:"token number"}},[s._v("8066")]),n("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("{")]),s._v("\n\tdelay_loop "),n("span",{pre:!0,attrs:{class:"token number"}},[s._v("3")]),s._v("\n\tlb_algo rr\n\tlb_kind NAT\n\tpersistence "),n("span",{pre:!0,attrs:{class:"token function"}},[s._v("timeout")]),s._v(" "),n("span",{pre:!0,attrs:{class:"token number"}},[s._v("50")]),s._v("\n\tprotocol TCP\n\treal_server "),n("span",{pre:!0,attrs:{class:"token number"}},[s._v("172.18")]),s._v(".0.201 "),n("span",{pre:!0,attrs:{class:"token number"}},[s._v("8066")]),n("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("{")]),s._v("\n\t  weight "),n("span",{pre:!0,attrs:{class:"token number"}},[s._v("1")]),s._v("\n\t"),n("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("}")]),s._v("\n"),n("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("}")]),s._v("\n\nvirtual_server "),n("span",{pre:!0,attrs:{class:"token number"}},[s._v("192.168")]),s._v(".56.107 "),n("span",{pre:!0,attrs:{class:"token number"}},[s._v("9066")]),n("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("{")]),s._v("\n\tdelay_loop "),n("span",{pre:!0,attrs:{class:"token number"}},[s._v("3")]),s._v("\n\tlb_algo rr\n\tlb_kind NAT\n\tpersistence "),n("span",{pre:!0,attrs:{class:"token function"}},[s._v("timeout")]),s._v(" "),n("span",{pre:!0,attrs:{class:"token number"}},[s._v("50")]),s._v("\n\tprotocol TCP\n\treal_server "),n("span",{pre:!0,attrs:{class:"token number"}},[s._v("172.18")]),s._v(".0.201 "),n("span",{pre:!0,attrs:{class:"token number"}},[s._v("9066")]),n("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("{")]),s._v("\n\t  weight "),n("span",{pre:!0,attrs:{class:"token number"}},[s._v("1")]),s._v("\n\t"),n("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("}")]),s._v("\n"),n("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("}")]),s._v("\n")])]),s._v(" "),n("div",{staticClass:"line-numbers-wrapper"},[n("span",{staticClass:"line-number"},[s._v("1")]),n("br"),n("span",{staticClass:"line-number"},[s._v("2")]),n("br"),n("span",{staticClass:"line-number"},[s._v("3")]),n("br"),n("span",{staticClass:"line-number"},[s._v("4")]),n("br"),n("span",{staticClass:"line-number"},[s._v("5")]),n("br"),n("span",{staticClass:"line-number"},[s._v("6")]),n("br"),n("span",{staticClass:"line-number"},[s._v("7")]),n("br"),n("span",{staticClass:"line-number"},[s._v("8")]),n("br"),n("span",{staticClass:"line-number"},[s._v("9")]),n("br"),n("span",{staticClass:"line-number"},[s._v("10")]),n("br"),n("span",{staticClass:"line-number"},[s._v("11")]),n("br"),n("span",{staticClass:"line-number"},[s._v("12")]),n("br"),n("span",{staticClass:"line-number"},[s._v("13")]),n("br"),n("span",{staticClass:"line-number"},[s._v("14")]),n("br"),n("span",{staticClass:"line-number"},[s._v("15")]),n("br"),n("span",{staticClass:"line-number"},[s._v("16")]),n("br"),n("span",{staticClass:"line-number"},[s._v("17")]),n("br"),n("span",{staticClass:"line-number"},[s._v("18")]),n("br"),n("span",{staticClass:"line-number"},[s._v("19")]),n("br"),n("span",{staticClass:"line-number"},[s._v("20")]),n("br"),n("span",{staticClass:"line-number"},[s._v("21")]),n("br"),n("span",{staticClass:"line-number"},[s._v("22")]),n("br"),n("span",{staticClass:"line-number"},[s._v("23")]),n("br"),n("span",{staticClass:"line-number"},[s._v("24")]),n("br"),n("span",{staticClass:"line-number"},[s._v("25")]),n("br"),n("span",{staticClass:"line-number"},[s._v("26")]),n("br"),n("span",{staticClass:"line-number"},[s._v("27")]),n("br"),n("span",{staticClass:"line-number"},[s._v("28")]),n("br"),n("span",{staticClass:"line-number"},[s._v("29")]),n("br"),n("span",{staticClass:"line-number"},[s._v("30")]),n("br"),n("span",{staticClass:"line-number"},[s._v("31")]),n("br"),n("span",{staticClass:"line-number"},[s._v("32")]),n("br"),n("span",{staticClass:"line-number"},[s._v("33")]),n("br"),n("span",{staticClass:"line-number"},[s._v("34")]),n("br"),n("span",{staticClass:"line-number"},[s._v("35")]),n("br"),n("span",{staticClass:"line-number"},[s._v("36")]),n("br")])]),n("p",[s._v("测试方案，和第一个里面的类似。把 Mycat1 容器关掉，看看还能不能访问到 mycat 呢？笔者测试是可以的")])])}),[],!1,null,null,null);t.default=e.exports}}]);
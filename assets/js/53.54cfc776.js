(window.webpackJsonp=window.webpackJsonp||[]).push([[53],{417:function(s,a,t){s.exports=t.p+"assets/img/image-20200607152047353.d6308396.png"},658:function(s,a,t){"use strict";t.r(a);var e=t(15),n=Object(e.a)({},(function(){var s=this,a=s.$createElement,e=s._self._c||a;return e("ContentSlotsDistributor",{attrs:{"slot-key":s.$parent.slotKey}},[e("h1",{attrs:{id:"在线修改表结构"}},[e("a",{staticClass:"header-anchor",attrs:{href:"#在线修改表结构"}},[s._v("#")]),s._v(" 在线修改表结构")]),s._v(" "),e("p",[s._v("场景：对一个正在运营的电商网站修改表结构")]),s._v(" "),e("h2",{attrs:{id:"在线修改表结构必须慎重"}},[e("a",{staticClass:"header-anchor",attrs:{href:"#在线修改表结构必须慎重"}},[s._v("#")]),s._v(" 在线修改表结构必须慎重")]),s._v(" "),e("ul",[e("li",[e("p",[s._v("在业务系统 "),e("strong",[s._v("运行")]),s._v(" 过程中随意删改字段，会 "),e("strong",[s._v("造成重大事故")]),s._v("。")])]),s._v(" "),e("li",[e("p",[s._v("常规的做法是："),e("strong",[s._v("业务停机")]),s._v("，再 "),e("strong",[s._v("维护表结构")])]),s._v(" "),e("p",[s._v("比如：12306 凌晨 0 点到早上 7 点是停机维护")])]),s._v(" "),e("li",[e("p",[s._v("如果是不影响正常业务的表结构是允许在线修改的。")]),s._v(" "),e("p",[s._v("比如：int 类型不够用了，要缓存 bigint、有唯一性约束，要去掉。这不会影响线上的正在执行的数据")])])]),s._v(" "),e("h2",{attrs:{id:"alter-table-修改表结构的弊端"}},[e("a",{staticClass:"header-anchor",attrs:{href:"#alter-table-修改表结构的弊端"}},[s._v("#")]),s._v(" alter table 修改表结构的弊端")]),s._v(" "),e("ul",[e("li",[e("p",[s._v("表级锁")]),s._v(" "),e("p",[s._v("修改表结构会锁表，因此在修改表结构时，影响表的写入操作；")]),s._v(" "),e("p",[s._v("数据越多，锁表时间越长。")])]),s._v(" "),e("li",[e("p",[s._v("修改失败，还原表结构，耗时长")]),s._v(" "),e("p",[s._v("如果修改表结果失败，必须还原表结构，所以耗时更长；")]),s._v(" "),e("p",[s._v("比如：添加一个唯一性约束，结果发现很多数据有控制，无法添加进来了，这个时候就只能还原表结构")])]),s._v(" "),e("li",[e("p",[s._v("大数据表记录多，修改表结构锁表时间很久")])])]),s._v(" "),e("h2",{attrs:{id:"使用-perconatookit-工具"}},[e("a",{staticClass:"header-anchor",attrs:{href:"#使用-perconatookit-工具"}},[s._v("#")]),s._v(" 使用 PerconaTookit 工具")]),s._v(" "),e("p",[s._v("由于 alter table 线上修改表结构有诸多弊端，但是 PerconaTookit 提供了一个开源的线上修改表结构的工具。")]),s._v(" "),e("p",[s._v("其中一个名为 "),e("strong",[s._v("pt-online-schema-change")]),s._v(" 的工具可以完成在线修改表结构。")]),s._v(" "),e("h2",{attrs:{id:"在线修改表结构的原理"}},[e("a",{staticClass:"header-anchor",attrs:{href:"#在线修改表结构的原理"}},[s._v("#")]),s._v(" 在线修改表结构的原理")]),s._v(" "),e("p",[e("strong",[s._v("pt-online-schema-change")]),s._v(" 是如何做到不锁表修改表结构的？")]),s._v(" "),e("p",[s._v("我要修改 order 表的结构， "),e("strong",[s._v("pt-online-schema-change")]),s._v(" 会这样做：")]),s._v(" "),e("ol",[e("li",[e("p",[s._v("复制一份 order 表结构")])]),s._v(" "),e("li",[e("p",[s._v("在这个新表的修改表结构")])]),s._v(" "),e("li",[e("p",[s._v("同步执行数据拷贝")]),s._v(" "),e("p",[s._v("修改完成之后，会在原来表上增加触发器，新的操作数据增删改查都会同步到新的表中，")]),s._v(" "),e("p",[s._v("同时会把原来表的数据拷贝到新表中。")]),s._v(" "),e("p",[s._v("当数据拷贝完之后，且 "),e("strong",[s._v("原表没有新的数据写入时")]),s._v("，把原表删除，把新表名称修改为原表名称")])])]),s._v(" "),e("p",[s._v("笔者其实很疑惑的是：它这个表数据同步原理，这里说得不够清楚，说得很模糊。在同步时修改了原来表的数据怎么办？原表的数据都还没有同步完成。")]),s._v(" "),e("h2",{attrs:{id:"安装-perconatookit-依赖包"}},[e("a",{staticClass:"header-anchor",attrs:{href:"#安装-perconatookit-依赖包"}},[s._v("#")]),s._v(" 安装 PerconaTookit 依赖包")]),s._v(" "),e("p",[s._v("该依赖包与 MySQL 8 有冲突？不要安装在同一台上面？")]),s._v(" "),e("p",[s._v("安装第三方依赖包")]),s._v(" "),e("div",{staticClass:"language-bash line-numbers-mode"},[e("pre",{pre:!0,attrs:{class:"language-bash"}},[e("code",[s._v("yum "),e("span",{pre:!0,attrs:{class:"token function"}},[s._v("install")]),s._v(" -y perl-DBI\nyum "),e("span",{pre:!0,attrs:{class:"token function"}},[s._v("install")]),s._v(" -y perl-DBD-mysql\nyum "),e("span",{pre:!0,attrs:{class:"token function"}},[s._v("install")]),s._v(" -y perl-IO-Socket-SSL\nyum "),e("span",{pre:!0,attrs:{class:"token function"}},[s._v("install")]),s._v(" -y perl-Digest-MD5\nyum "),e("span",{pre:!0,attrs:{class:"token function"}},[s._v("install")]),s._v(" -y perl-TermReadKey\n")])]),s._v(" "),e("div",{staticClass:"line-numbers-wrapper"},[e("span",{staticClass:"line-number"},[s._v("1")]),e("br"),e("span",{staticClass:"line-number"},[s._v("2")]),e("br"),e("span",{staticClass:"line-number"},[s._v("3")]),e("br"),e("span",{staticClass:"line-number"},[s._v("4")]),e("br"),e("span",{staticClass:"line-number"},[s._v("5")]),e("br")])]),e("p",[s._v("安装 PerconaTookit 工具")]),s._v(" "),e("div",{staticClass:"language-sql line-numbers-mode"},[e("pre",{pre:!0,attrs:{class:"language-sql"}},[e("code",[s._v("rpm "),e("span",{pre:!0,attrs:{class:"token operator"}},[s._v("-")]),s._v("ivh percona"),e("span",{pre:!0,attrs:{class:"token operator"}},[s._v("-")]),s._v("toolkit"),e("span",{pre:!0,attrs:{class:"token operator"}},[s._v("-")]),e("span",{pre:!0,attrs:{class:"token number"}},[s._v("3.0")]),e("span",{pre:!0,attrs:{class:"token number"}},[s._v(".13")]),e("span",{pre:!0,attrs:{class:"token operator"}},[s._v("-")]),e("span",{pre:!0,attrs:{class:"token number"}},[s._v("1.")]),s._v("el7"),e("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(".")]),s._v("x86_64"),e("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(".")]),s._v("rpm\nrpm "),e("span",{pre:!0,attrs:{class:"token operator"}},[s._v("-")]),s._v("ivh percona"),e("span",{pre:!0,attrs:{class:"token operator"}},[s._v("-")]),s._v("toolkit"),e("span",{pre:!0,attrs:{class:"token operator"}},[s._v("-")]),s._v("debuginfo"),e("span",{pre:!0,attrs:{class:"token operator"}},[s._v("-")]),e("span",{pre:!0,attrs:{class:"token number"}},[s._v("3.0")]),e("span",{pre:!0,attrs:{class:"token number"}},[s._v(".13")]),e("span",{pre:!0,attrs:{class:"token operator"}},[s._v("-")]),e("span",{pre:!0,attrs:{class:"token number"}},[s._v("1.")]),s._v("el7"),e("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(".")]),s._v("x86_64"),e("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(".")]),s._v("rpm\n")])]),s._v(" "),e("div",{staticClass:"line-numbers-wrapper"},[e("span",{staticClass:"line-number"},[s._v("1")]),e("br"),e("span",{staticClass:"line-number"},[s._v("2")]),e("br")])]),e("h2",{attrs:{id:"pt-online-schema-change-用法"}},[e("a",{staticClass:"header-anchor",attrs:{href:"#pt-online-schema-change-用法"}},[s._v("#")]),s._v(" "),e("strong",[s._v("pt-online-schema-change")]),s._v(" 用法")]),s._v(" "),e("div",{staticClass:"language-bash line-numbers-mode"},[e("pre",{pre:!0,attrs:{class:"language-bash"}},[e("code",[s._v("pt-online-schema-change OPTIONS DSN\n\n参数有：\n\n--host: 地址\n--user: 用户名\n--password：密码\n--port：端口号\nD：逻辑库\nt：数据表\n--alter：修改语句\n--execute：执行修改\n--dry-run：测试执行\n--print：打印过程\n")])]),s._v(" "),e("div",{staticClass:"line-numbers-wrapper"},[e("span",{staticClass:"line-number"},[s._v("1")]),e("br"),e("span",{staticClass:"line-number"},[s._v("2")]),e("br"),e("span",{staticClass:"line-number"},[s._v("3")]),e("br"),e("span",{staticClass:"line-number"},[s._v("4")]),e("br"),e("span",{staticClass:"line-number"},[s._v("5")]),e("br"),e("span",{staticClass:"line-number"},[s._v("6")]),e("br"),e("span",{staticClass:"line-number"},[s._v("7")]),e("br"),e("span",{staticClass:"line-number"},[s._v("8")]),e("br"),e("span",{staticClass:"line-number"},[s._v("9")]),e("br"),e("span",{staticClass:"line-number"},[s._v("10")]),e("br"),e("span",{staticClass:"line-number"},[s._v("11")]),e("br"),e("span",{staticClass:"line-number"},[s._v("12")]),e("br"),e("span",{staticClass:"line-number"},[s._v("13")]),e("br"),e("span",{staticClass:"line-number"},[s._v("14")]),e("br")])]),e("p",[s._v("实践")]),s._v(" "),e("p",[s._v("在执行前还需要修改下密码认证方式，因为该工具不支持 MySQL8 新的默认认证方式，将认证方式改成低版本的方式")]),s._v(" "),e("div",{staticClass:"language-sql line-numbers-mode"},[e("pre",{pre:!0,attrs:{class:"language-sql"}},[e("code",[e("span",{pre:!0,attrs:{class:"token keyword"}},[s._v("alter")]),s._v(" "),e("span",{pre:!0,attrs:{class:"token keyword"}},[s._v("user")]),s._v(" "),e("span",{pre:!0,attrs:{class:"token string"}},[s._v("'root'")]),e("span",{pre:!0,attrs:{class:"token variable"}},[s._v("@'%'")]),s._v(" identified "),e("span",{pre:!0,attrs:{class:"token keyword"}},[s._v("by")]),s._v(" "),e("span",{pre:!0,attrs:{class:"token string"}},[s._v("'password'")]),s._v(" password expire never"),e("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(";")]),s._v("\n"),e("span",{pre:!0,attrs:{class:"token keyword"}},[s._v("alter")]),s._v(" "),e("span",{pre:!0,attrs:{class:"token keyword"}},[s._v("user")]),s._v(" "),e("span",{pre:!0,attrs:{class:"token string"}},[s._v("'root'")]),e("span",{pre:!0,attrs:{class:"token variable"}},[s._v("@'%'")]),s._v(" identified "),e("span",{pre:!0,attrs:{class:"token keyword"}},[s._v("with")]),s._v(" mysql_native_password "),e("span",{pre:!0,attrs:{class:"token keyword"}},[s._v("by")]),s._v(" "),e("span",{pre:!0,attrs:{class:"token string"}},[s._v("'123456'")]),e("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(";")]),s._v("\n")])]),s._v(" "),e("div",{staticClass:"line-numbers-wrapper"},[e("span",{staticClass:"line-number"},[s._v("1")]),e("br"),e("span",{staticClass:"line-number"},[s._v("2")]),e("br")])]),e("div",{staticClass:"language-sql line-numbers-mode"},[e("pre",{pre:!0,attrs:{class:"language-sql"}},[e("code",[e("span",{pre:!0,attrs:{class:"token comment"}},[s._v("-- 把客户收货地址表中的 name 字段改成  varchar(20)")]),s._v("\n\npt"),e("span",{pre:!0,attrs:{class:"token operator"}},[s._v("-")]),s._v("online"),e("span",{pre:!0,attrs:{class:"token operator"}},[s._v("-")]),e("span",{pre:!0,attrs:{class:"token keyword"}},[s._v("schema")]),e("span",{pre:!0,attrs:{class:"token operator"}},[s._v("-")]),s._v("change "),e("span",{pre:!0,attrs:{class:"token comment"}},[s._v("--host=192.168.56.101 --port=3306 --user=root --password=123456 --alter \"modify name varchar(20) not null comment '收货人'\" D=neti,t=t_customer_address --print --execute")]),s._v("\n\n"),e("span",{pre:!0,attrs:{class:"token comment"}},[s._v("-- 笔者这里执行完成之后，报错了")]),s._v("\nThere "),e("span",{pre:!0,attrs:{class:"token operator"}},[s._v("is")]),s._v(" an error "),e("span",{pre:!0,attrs:{class:"token operator"}},[s._v("in")]),s._v(" MySQL that makes the server "),e("span",{pre:!0,attrs:{class:"token keyword"}},[s._v("to")]),s._v(" die "),e("span",{pre:!0,attrs:{class:"token keyword"}},[s._v("when")]),s._v(" trying "),e("span",{pre:!0,attrs:{class:"token keyword"}},[s._v("to")]),s._v(" "),e("span",{pre:!0,attrs:{class:"token keyword"}},[s._v("rename")]),s._v(" a "),e("span",{pre:!0,attrs:{class:"token keyword"}},[s._v("table")]),s._v(" "),e("span",{pre:!0,attrs:{class:"token keyword"}},[s._v("with")]),s._v(" FKs"),e("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(".")]),s._v(" See https:"),e("span",{pre:!0,attrs:{class:"token comment"}},[s._v("//bugs.mysql.com/bug.php?id=96145")]),s._v("\nSince pt"),e("span",{pre:!0,attrs:{class:"token operator"}},[s._v("-")]),s._v("online"),e("span",{pre:!0,attrs:{class:"token operator"}},[s._v("-")]),e("span",{pre:!0,attrs:{class:"token keyword"}},[s._v("schema")]),s._v(" change needs "),e("span",{pre:!0,attrs:{class:"token keyword"}},[s._v("to")]),s._v(" "),e("span",{pre:!0,attrs:{class:"token keyword"}},[s._v("rename")]),s._v(" the old "),e("span",{pre:!0,attrs:{class:"token operator"}},[s._v("<")]),e("span",{pre:!0,attrs:{class:"token operator"}},[s._v("-")]),e("span",{pre:!0,attrs:{class:"token operator"}},[s._v(">")]),s._v(" new "),e("span",{pre:!0,attrs:{class:"token keyword"}},[s._v("tables")]),s._v(" "),e("span",{pre:!0,attrs:{class:"token keyword"}},[s._v("as")]),s._v(" the final step"),e("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(",")]),s._v(" "),e("span",{pre:!0,attrs:{class:"token operator"}},[s._v("and")]),s._v(" the requested "),e("span",{pre:!0,attrs:{class:"token keyword"}},[s._v("table")]),s._v(" has FKs"),e("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(",")]),s._v(" it cannot be executed under the "),e("span",{pre:!0,attrs:{class:"token keyword"}},[s._v("current")]),s._v(" MySQL version\n\n难道死是 MySQL 版本的问题？还是工具版本的问题？ 这个就不清楚了。 \n")])]),s._v(" "),e("div",{staticClass:"line-numbers-wrapper"},[e("span",{staticClass:"line-number"},[s._v("1")]),e("br"),e("span",{staticClass:"line-number"},[s._v("2")]),e("br"),e("span",{staticClass:"line-number"},[s._v("3")]),e("br"),e("span",{staticClass:"line-number"},[s._v("4")]),e("br"),e("span",{staticClass:"line-number"},[s._v("5")]),e("br"),e("span",{staticClass:"line-number"},[s._v("6")]),e("br"),e("span",{staticClass:"line-number"},[s._v("7")]),e("br"),e("span",{staticClass:"line-number"},[s._v("8")]),e("br"),e("span",{staticClass:"line-number"},[s._v("9")]),e("br")])]),e("p",[s._v("下面是执行成功的截图")]),s._v(" "),e("p",[e("img",{attrs:{src:t(417),alt:"image-20200607152047353"}})]),s._v(" "),e("p",[s._v("也可以看到的确是有一些触发器的操作。")])])}),[],!1,null,null,null);a.default=n.exports}}]);
(window.webpackJsonp=window.webpackJsonp||[]).push([[44],{455:function(t,e,a){t.exports=a.p+"assets/img/image-20200617214708928.95826721.png"},456:function(t,e,a){t.exports=a.p+"assets/img/image-20200617214826011.499e3395.png"},701:function(t,e,a){"use strict";a.r(e);var s=a(15),n=Object(s.a)({},(function(){var t=this,e=t.$createElement,s=t._self._c||e;return s("ContentSlotsDistributor",{attrs:{"slot-key":t.$parent.slotKey}},[s("h1",{attrs:{id:"搭建-replication-集群"}},[s("a",{staticClass:"header-anchor",attrs:{href:"#搭建-replication-集群"}},[t._v("#")]),t._v(" 搭建 Replication 集群")]),t._v(" "),s("p",[t._v("PXC 集群适合存放高价值的数据，那么大量低价值的数据就不适合保存在 PCX 集群中；")]),t._v(" "),s("p",[t._v("如用户评价信息。")]),t._v(" "),s("p",[t._v("Replication 集群是 MySQL 自带的数据同步机制。简单讲解下它的同步原理：")]),t._v(" "),s("p",[s("img",{attrs:{src:a(455),alt:"image-20200617214708928"}})]),t._v(" "),s("ol",[s("li",[s("p",[t._v("第一个 MySQL 开启 bin_log 日志")]),t._v(" "),s("p",[t._v("所有使用 MySQL 的操作，都会被记录在该文件中")])]),t._v(" "),s("li",[s("p",[t._v("第二个 MySQL 读取第一个 MySQL 的 bin_log 日志")]),t._v(" "),s("p",[t._v("就知道第一个 MySQL 执行了哪些操作，并且把这些操作在本地也执行一遍")])])]),t._v(" "),s("p",[t._v("这里可以看出来，数据同步是 "),s("strong",[t._v("单向")]),t._v(" 的，而 PXC 集群是双向的。")]),t._v(" "),s("h2",{attrs:{id:"主从同步关系"}},[s("a",{staticClass:"header-anchor",attrs:{href:"#主从同步关系"}},[t._v("#")]),t._v(" 主从同步关系")]),t._v(" "),s("p",[s("img",{attrs:{src:a(456),alt:"image-20200617214826011"}})]),t._v(" "),s("p",[t._v("Replication 集群中，数据同步是单向的，从主节点（Master）同步到从节点（Slave）；")]),t._v(" "),s("p",[t._v("如果你的场景是读多写少的，就可以给 master 配置多个 Slave 节点，查询数据的操作都走 Slave，写操作走 Master，就可以实现读写分离的功能。")]),t._v(" "),s("h2",{attrs:{id:"下载安装-replication-镜像"}},[s("a",{staticClass:"header-anchor",attrs:{href:"#下载安装-replication-镜像"}},[t._v("#")]),t._v(" 下载安装 Replication 镜像")]),t._v(" "),s("p",[t._v("Oracle 并没有提供官方的 Replication 镜像，所以只能安装第三方封装的镜像文件。")]),t._v(" "),s("p",[t._v("Replication 就是 MySQL server，通过配置文件 my.cnf 配置主从的，这里说使用第三方的，应该是封装之后，使用起来更简单？")]),t._v(" "),s("div",{staticClass:"language-bash line-numbers-mode"},[s("pre",{pre:!0,attrs:{class:"language-bash"}},[s("code",[s("span",{pre:!0,attrs:{class:"token comment"}},[t._v("# 下载镜像后，修改它的名称，把名称修改短一点")]),t._v("\ndocker pull mishamx/mysql\ndocker tag mishamx/mysql rep\ndocker rmi  mishamx/mysql\n")])]),t._v(" "),s("div",{staticClass:"line-numbers-wrapper"},[s("span",{staticClass:"line-number"},[t._v("1")]),s("br"),s("span",{staticClass:"line-number"},[t._v("2")]),s("br"),s("span",{staticClass:"line-number"},[t._v("3")]),s("br"),s("span",{staticClass:"line-number"},[t._v("4")]),s("br")])]),s("h2",{attrs:{id:"replication-集群的结构"}},[s("a",{staticClass:"header-anchor",attrs:{href:"#replication-集群的结构"}},[t._v("#")]),t._v(" Replication 集群的结构")]),t._v(" "),s("p",[t._v("为了实现数据分片，Replication 也是要进行数据分片的。所以先来搭建一个 Replication 集群，成功的话，再去搭建第二个。")]),t._v(" "),s("table",[s("thead",[s("tr",[s("th",{staticStyle:{"text-align":"center"}},[t._v("虚拟机")]),t._v(" "),s("th",{staticStyle:{"text-align":"center"}},[t._v("IP 地址")]),t._v(" "),s("th",{staticStyle:{"text-align":"center"}},[t._v("端口")]),t._v(" "),s("th",{staticStyle:{"text-align":"center"}},[t._v("容器")]),t._v(" "),s("th",{staticStyle:{"text-align":"center"}},[t._v("数据卷")])])]),t._v(" "),s("tbody",[s("tr",[s("td",{staticStyle:{"text-align":"center"}},[t._v("docker-1")]),t._v(" "),s("td",{staticStyle:{"text-align":"center"}},[t._v("192.168.56.105")]),t._v(" "),s("td",{staticStyle:{"text-align":"center"}},[t._v("9003")]),t._v(" "),s("td",{staticStyle:{"text-align":"center"}},[t._v("rn1(m)")]),t._v(" "),s("td",{staticStyle:{"text-align":"center"}},[t._v("rnv1")])]),t._v(" "),s("tr",[s("td",{staticStyle:{"text-align":"center"}},[t._v("docker-2")]),t._v(" "),s("td",{staticStyle:{"text-align":"center"}},[t._v("192.168.56.107")]),t._v(" "),s("td",{staticStyle:{"text-align":"center"}},[t._v("9003")]),t._v(" "),s("td",{staticStyle:{"text-align":"center"}},[t._v("rn2(s)")]),t._v(" "),s("td",{staticStyle:{"text-align":"center"}},[t._v("rnv2")])]),t._v(" "),s("tr",[s("td",{staticStyle:{"text-align":"center"}},[t._v("docker-3")]),t._v(" "),s("td",{staticStyle:{"text-align":"center"}},[t._v("192.168.56.108")]),t._v(" "),s("td",{staticStyle:{"text-align":"center"}},[t._v("9003")]),t._v(" "),s("td",{staticStyle:{"text-align":"center"}},[t._v("rn3(s)")]),t._v(" "),s("td",{staticStyle:{"text-align":"center"}},[t._v("nv3")])])])]),t._v(" "),s("p",[t._v("rn1作为 master 节点，其余两个作为 Slave 节点。")]),t._v(" "),s("h2",{attrs:{id:"创建主节点容器"}},[s("a",{staticClass:"header-anchor",attrs:{href:"#创建主节点容器"}},[t._v("#")]),t._v(" 创建主节点容器")]),t._v(" "),s("p",[t._v("主节点用来让其他节点与之同步，而且主节点身份是固定的。")]),t._v(" "),s("p",[t._v("使用镜像命令参数，该镜像是封装了 MySQL 官方的 Replication 配置，一定要知道 Replication 最原始的搭建方式。")]),t._v(" "),s("div",{staticClass:"language-bash line-numbers-mode"},[s("pre",{pre:!0,attrs:{class:"language-bash"}},[s("code",[t._v("docker run -d -p "),s("span",{pre:!0,attrs:{class:"token number"}},[t._v("9003")]),t._v(":3306 --name rn1\n-e "),s("span",{pre:!0,attrs:{class:"token assign-left variable"}},[t._v("MYSQL_MASTER_PORT")]),s("span",{pre:!0,attrs:{class:"token operator"}},[t._v("=")]),s("span",{pre:!0,attrs:{class:"token number"}},[t._v("3306")]),t._v("\n-e "),s("span",{pre:!0,attrs:{class:"token assign-left variable"}},[t._v("MYSQL_ROOT_PASSWORD")]),s("span",{pre:!0,attrs:{class:"token operator"}},[t._v("=")]),s("span",{pre:!0,attrs:{class:"token number"}},[t._v("123456")]),t._v("\t\t\t\t\t\t\t"),s("span",{pre:!0,attrs:{class:"token comment"}},[t._v("# 设置数据库 ROOT 账户密码")]),t._v("\n-e "),s("span",{pre:!0,attrs:{class:"token assign-left variable"}},[t._v("MYSQL_REPLICATION_USER")]),s("span",{pre:!0,attrs:{class:"token operator"}},[t._v("=")]),t._v("backup\t\t\t\t\t"),s("span",{pre:!0,attrs:{class:"token comment"}},[t._v("# 创建一个新的 mysql 账户，仅用来做数据同步")]),t._v("\n-e "),s("span",{pre:!0,attrs:{class:"token assign-left variable"}},[t._v("MYSQL_REPLICATION_PASSWORD")]),s("span",{pre:!0,attrs:{class:"token operator"}},[t._v("=")]),s("span",{pre:!0,attrs:{class:"token number"}},[t._v("123456")]),t._v("\t\t\t"),s("span",{pre:!0,attrs:{class:"token comment"}},[t._v("# 设置分配一个密码")]),t._v("\n-V rnv1:/var/lib/mysql --privileged\t\t\t\t"),s("span",{pre:!0,attrs:{class:"token comment"}},[t._v("# 数据卷")]),t._v("\n--net"),s("span",{pre:!0,attrs:{class:"token operator"}},[t._v("=")]),t._v("swarm_mysql rep\n")])]),t._v(" "),s("div",{staticClass:"line-numbers-wrapper"},[s("span",{staticClass:"line-number"},[t._v("1")]),s("br"),s("span",{staticClass:"line-number"},[t._v("2")]),s("br"),s("span",{staticClass:"line-number"},[t._v("3")]),s("br"),s("span",{staticClass:"line-number"},[t._v("4")]),s("br"),s("span",{staticClass:"line-number"},[t._v("5")]),s("br"),s("span",{staticClass:"line-number"},[t._v("6")]),s("br"),s("span",{staticClass:"line-number"},[t._v("7")]),s("br")])]),s("p",[t._v("下面来实操")]),t._v(" "),s("div",{staticClass:"language-bash line-numbers-mode"},[s("pre",{pre:!0,attrs:{class:"language-bash"}},[s("code",[s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("[")]),t._v("root@study /"),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("]")]),s("span",{pre:!0,attrs:{class:"token comment"}},[t._v("# docker run -d -p 9003:3306 --name rn1 -e MYSQL_MASTER_PORT=3306 -e MYSQL_ROOT_PASSWORD=123456 -e MYSQL_REPLICATION_USER=backup -e MYSQL_REPLICATION_PASSWORD=123456 -v rnv1:/var/lib/mysql --privileged --net=swarm_mysql rep")]),t._v("\n7d9d59aed2af2d766f5413c70530ed6b294601dcb1c4cc3aeab51ca92fac3a7f\n")])]),t._v(" "),s("div",{staticClass:"line-numbers-wrapper"},[s("span",{staticClass:"line-number"},[t._v("1")]),s("br"),s("span",{staticClass:"line-number"},[t._v("2")]),s("br")])]),s("p",[t._v("等一会初始后，通过 Navicat 去连接 9300 端口，看是否能够链接上这个数据库")]),t._v(" "),s("h2",{attrs:{id:"创建从节点容器"}},[s("a",{staticClass:"header-anchor",attrs:{href:"#创建从节点容器"}},[t._v("#")]),t._v(" 创建从节点容器")]),t._v(" "),s("p",[t._v("从节点需要与主节点同步数据，没有主节点不能创建从节点，要保证主节点已经创建成功，再来创建从节点")]),t._v(" "),s("div",{staticClass:"language-bash line-numbers-mode"},[s("pre",{pre:!0,attrs:{class:"language-bash"}},[s("code",[t._v("docker run -d -p "),s("span",{pre:!0,attrs:{class:"token number"}},[t._v("9003")]),t._v(":3306 --name rn2\n-e "),s("span",{pre:!0,attrs:{class:"token assign-left variable"}},[t._v("MySQL_MASTER_HOST")]),s("span",{pre:!0,attrs:{class:"token operator"}},[t._v("=")]),t._v("rn1\t\t\t\t\t\t\t\t\t"),s("span",{pre:!0,attrs:{class:"token comment"}},[t._v("#### 增加了这一行配置，指向了主节点容器名称")]),t._v("\n-e "),s("span",{pre:!0,attrs:{class:"token assign-left variable"}},[t._v("MYSQL_MASTER_PORT")]),s("span",{pre:!0,attrs:{class:"token operator"}},[t._v("=")]),s("span",{pre:!0,attrs:{class:"token number"}},[t._v("3306")]),t._v("\n-e "),s("span",{pre:!0,attrs:{class:"token assign-left variable"}},[t._v("MYSQL_ROOT_PASSWORD")]),s("span",{pre:!0,attrs:{class:"token operator"}},[t._v("=")]),s("span",{pre:!0,attrs:{class:"token number"}},[t._v("123456")]),t._v("\t\t\t\t\t\t\t"),s("span",{pre:!0,attrs:{class:"token comment"}},[t._v("# 设置数据库 ROOT 账户密码")]),t._v("\n-e "),s("span",{pre:!0,attrs:{class:"token assign-left variable"}},[t._v("MYSQL_REPLICATION_USER")]),s("span",{pre:!0,attrs:{class:"token operator"}},[t._v("=")]),t._v("backup\t\t\t\t\t"),s("span",{pre:!0,attrs:{class:"token comment"}},[t._v("# 创建一个新的 mysql 账户，仅用来做数据同步")]),t._v("\n-e "),s("span",{pre:!0,attrs:{class:"token assign-left variable"}},[t._v("MYSQL_REPLICATION_PASSWORD")]),s("span",{pre:!0,attrs:{class:"token operator"}},[t._v("=")]),s("span",{pre:!0,attrs:{class:"token number"}},[t._v("123456")]),t._v("\t\t\t"),s("span",{pre:!0,attrs:{class:"token comment"}},[t._v("# 设置分配一个密码")]),t._v("\n-V rnv2:/var/lib/mysql --privileged\t\t\t\t"),s("span",{pre:!0,attrs:{class:"token comment"}},[t._v("# 数据卷")]),t._v("\n--net"),s("span",{pre:!0,attrs:{class:"token operator"}},[t._v("=")]),t._v("swarm_mysql rep\n")])]),t._v(" "),s("div",{staticClass:"line-numbers-wrapper"},[s("span",{staticClass:"line-number"},[t._v("1")]),s("br"),s("span",{staticClass:"line-number"},[t._v("2")]),s("br"),s("span",{staticClass:"line-number"},[t._v("3")]),s("br"),s("span",{staticClass:"line-number"},[t._v("4")]),s("br"),s("span",{staticClass:"line-number"},[t._v("5")]),s("br"),s("span",{staticClass:"line-number"},[t._v("6")]),s("br"),s("span",{staticClass:"line-number"},[t._v("7")]),s("br"),s("span",{staticClass:"line-number"},[t._v("8")]),s("br")])]),s("p",[t._v("从节点创建与主节点类似，只是多了配置主节点的参数。下面只记录了一台机器的从节点创建，需要把你规划的剩余机器也创建上")]),t._v(" "),s("div",{staticClass:"language-bash line-numbers-mode"},[s("pre",{pre:!0,attrs:{class:"language-bash"}},[s("code",[s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("[")]),t._v("root@study ~"),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("]")]),s("span",{pre:!0,attrs:{class:"token comment"}},[t._v("# docker run -d -p 9003:3306 --name rn2 -e MYSQL_MASTER_HOST=rn1 -e MYSQL_MASTER_PORT=3306 -e MYSQL_ROOT_PASSWORD=123456 -e MYSQL_REPLICATION_USER=backup -e MYSQL_REPLICATION_PASSWORD=123456 -v rnv2:/var/lib/mysql --privileged --net=swarm_mysql rep")]),t._v("\nc6f61a470d2b786bbaeb77ab540dc3454e2cbec2f9c39627ccc07280e92f3679\n")])]),t._v(" "),s("div",{staticClass:"line-numbers-wrapper"},[s("span",{staticClass:"line-number"},[t._v("1")]),s("br"),s("span",{staticClass:"line-number"},[t._v("2")]),s("br")])]),s("div",{staticClass:"custom-block tip"},[s("p",{staticClass:"custom-block-title"},[t._v("注意")]),t._v(" "),s("p",[t._v("镜像需要的参数 MYSQL_MASTER_HOST 别写错了，笔者就是写错了，导致数据同步不成功，删除做法如下：")]),t._v(" "),s("ol",[s("li",[s("p",[t._v("停止该容器")])]),t._v(" "),s("li",[s("p",[t._v("删除该容器")])]),t._v(" "),s("li",[s("p",[t._v("删除绑定的数据卷；")]),t._v(" "),s("p",[t._v("当数据卷存在的时候，就算参数对了，也不会覆盖数据卷中的配置，导致一直失败。所以一定要记得，删除该数据卷")])]),t._v(" "),s("li",[s("p",[t._v("使用正确的容器创建命令，创建")])])])]),t._v(" "),s("h2",{attrs:{id:"replication-集群的注意事项"}},[s("a",{staticClass:"header-anchor",attrs:{href:"#replication-集群的注意事项"}},[t._v("#")]),t._v(" Replication 集群的注意事项")]),t._v(" "),s("p",[t._v("这里讨论下 Replication 的使用，是否也会向  PXC 集群那样，关闭之后，再启动会闪退呢？")]),t._v(" "),s("ul",[s("li",[s("p",[t._v("主节点关闭，从节点会发生什么？")]),t._v(" "),s("p",[t._v("主节点关闭，"),s("strong",[t._v("从节点依然可以使用")]),t._v("，但是 "),s("strong",[t._v("主从同步机制失效")])])]),t._v(" "),s("li",[s("p",[t._v("不启动主节点，从节点能启动吗？")]),t._v(" "),s("p",[s("strong",[t._v("不启动主节点")]),t._v("，从节点也能启动，"),s("strong",[t._v("主从同步失效")])])])]),t._v(" "),s("h2",{attrs:{id:"搭建-replication-集群分片"}},[s("a",{staticClass:"header-anchor",attrs:{href:"#搭建-replication-集群分片"}},[t._v("#")]),t._v(" 搭建 Replication 集群分片")]),t._v(" "),s("p",[t._v("现在可以规划下搭建第二个 Replication 集群了。")]),t._v(" "),s("p",[t._v("强一致性与弱一致性：")]),t._v(" "),s("ul",[s("li",[t._v("PXC 是强一致性集群")]),t._v(" "),s("li",[t._v("Replication 是弱一致性集群")])]),t._v(" "),s("p",[t._v("这里有一个"),s("a",{attrs:{href:"http://www.imooc.com/learn/993",target:"_blank",rel:"noopener noreferrer"}},[t._v("免费课程"),s("OutboundLink")],1),t._v("，以项目演示为例，讲解 PXC 集群原理、PXC 数据同步与 Replication 同步的区别、PXC 的多节点并发写入、Docker 虚拟机部署 MySQL 集群，并以案例验证 Replication 方案的数据不一致性、PXC 方案数据一致性，等知识点。有兴趣可以去看看")]),t._v(" "),s("p",[t._v("数据切分与 PXC 集群一样，搭建两个集群分片，规划如下")]),t._v(" "),s("p",[t._v("REP 1")]),t._v(" "),s("table",[s("thead",[s("tr",[s("th",{staticStyle:{"text-align":"center"}},[t._v("虚拟机")]),t._v(" "),s("th",{staticStyle:{"text-align":"center"}},[t._v("IP 地址")]),t._v(" "),s("th",{staticStyle:{"text-align":"center"}},[t._v("端口")]),t._v(" "),s("th",{staticStyle:{"text-align":"center"}},[t._v("容器")]),t._v(" "),s("th",{staticStyle:{"text-align":"center"}},[t._v("数据卷")])])]),t._v(" "),s("tbody",[s("tr",[s("td",{staticStyle:{"text-align":"center"}},[t._v("docker-1")]),t._v(" "),s("td",{staticStyle:{"text-align":"center"}},[t._v("192.168.56.105")]),t._v(" "),s("td",{staticStyle:{"text-align":"center"}},[t._v("9003")]),t._v(" "),s("td",{staticStyle:{"text-align":"center"}},[t._v("rn1(m)")]),t._v(" "),s("td",{staticStyle:{"text-align":"center"}},[t._v("rnv1")])]),t._v(" "),s("tr",[s("td",{staticStyle:{"text-align":"center"}},[t._v("docker-2")]),t._v(" "),s("td",{staticStyle:{"text-align":"center"}},[t._v("192.168.56.107")]),t._v(" "),s("td",{staticStyle:{"text-align":"center"}},[t._v("9003")]),t._v(" "),s("td",{staticStyle:{"text-align":"center"}},[t._v("rn2(s)")]),t._v(" "),s("td",{staticStyle:{"text-align":"center"}},[t._v("rnv2")])]),t._v(" "),s("tr",[s("td",{staticStyle:{"text-align":"center"}},[t._v("docker-3")]),t._v(" "),s("td",{staticStyle:{"text-align":"center"}},[t._v("192.168.56.108")]),t._v(" "),s("td",{staticStyle:{"text-align":"center"}},[t._v("9003")]),t._v(" "),s("td",{staticStyle:{"text-align":"center"}},[t._v("rn3(s)")]),t._v(" "),s("td",{staticStyle:{"text-align":"center"}},[t._v("rnv3")])])])]),t._v(" "),s("p",[t._v("REP 2")]),t._v(" "),s("table",[s("thead",[s("tr",[s("th",{staticStyle:{"text-align":"center"}},[t._v("虚拟机")]),t._v(" "),s("th",{staticStyle:{"text-align":"center"}},[t._v("IP 地址")]),t._v(" "),s("th",{staticStyle:{"text-align":"center"}},[t._v("端口")]),t._v(" "),s("th",{staticStyle:{"text-align":"center"}},[t._v("容器")]),t._v(" "),s("th",{staticStyle:{"text-align":"center"}},[t._v("数据卷")])])]),t._v(" "),s("tbody",[s("tr",[s("td",{staticStyle:{"text-align":"center"}},[t._v("docker-1")]),t._v(" "),s("td",{staticStyle:{"text-align":"center"}},[t._v("192.168.56.105")]),t._v(" "),s("td",{staticStyle:{"text-align":"center"}},[t._v("9004")]),t._v(" "),s("td",{staticStyle:{"text-align":"center"}},[t._v("rn4(m)")]),t._v(" "),s("td",{staticStyle:{"text-align":"center"}},[t._v("rnv4")])]),t._v(" "),s("tr",[s("td",{staticStyle:{"text-align":"center"}},[t._v("docker-2")]),t._v(" "),s("td",{staticStyle:{"text-align":"center"}},[t._v("192.168.56.107")]),t._v(" "),s("td",{staticStyle:{"text-align":"center"}},[t._v("9004")]),t._v(" "),s("td",{staticStyle:{"text-align":"center"}},[t._v("rn5(s)")]),t._v(" "),s("td",{staticStyle:{"text-align":"center"}},[t._v("rnv5")])]),t._v(" "),s("tr",[s("td",{staticStyle:{"text-align":"center"}},[t._v("docker-3")]),t._v(" "),s("td",{staticStyle:{"text-align":"center"}},[t._v("192.168.56.108")]),t._v(" "),s("td",{staticStyle:{"text-align":"center"}},[t._v("9004")]),t._v(" "),s("td",{staticStyle:{"text-align":"center"}},[t._v("rn6(s)")]),t._v(" "),s("td",{staticStyle:{"text-align":"center"}},[t._v("rnv6")])])])]),t._v(" "),s("p",[t._v("如何做分片，是下一个大章节的内容。")])])}),[],!1,null,null,null);e.default=n.exports}}]);
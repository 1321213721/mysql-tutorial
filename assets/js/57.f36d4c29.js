(window.webpackJsonp=window.webpackJsonp||[]).push([[57],{423:function(s,t,a){s.exports=a.p+"assets/img/image-20200607212441588.b4f6db57.png"},662:function(s,t,a){"use strict";a.r(t);var n=a(15),e=Object(n.a)({},(function(){var s=this,t=s.$createElement,n=s._self._c||t;return n("ContentSlotsDistributor",{attrs:{"slot-key":s.$parent.slotKey}},[n("h1",{attrs:{id:"删改数据如何避免锁表？"}},[n("a",{staticClass:"header-anchor",attrs:{href:"#删改数据如何避免锁表？"}},[s._v("#")]),s._v(" 删改数据如何避免锁表？")]),s._v(" "),n("h2",{attrs:{id:"什么是锁机制？"}},[n("a",{staticClass:"header-anchor",attrs:{href:"#什么是锁机制？"}},[s._v("#")]),s._v(" 什么是锁机制？")]),s._v(" "),n("p",[s._v("平时 MySQL 执行语句的时候，会自动给数据加锁。")]),s._v(" "),n("p",[s._v("InnoDB 采用的是行级锁，删改数据的时候，MySQL 会锁住记录。")]),s._v(" "),n("p",[n("img",{attrs:{src:a(423),alt:"image-20200607212441588"}})]),s._v(" "),n("p",[s._v("比如：上图更新 3 条语句，只会锁住这三条记录。被锁住的记录有什么表现？这需要根据它使用的锁来说明")]),s._v(" "),n("h2",{attrs:{id:"共享锁和排它锁"}},[n("a",{staticClass:"header-anchor",attrs:{href:"#共享锁和排它锁"}},[s._v("#")]),s._v(" 共享锁和排它锁")]),s._v(" "),n("p",[s._v("行级锁分为：")]),s._v(" "),n("ul",[n("li",[s._v("共享锁（S 锁）")]),s._v(" "),n("li",[s._v("排它锁（X 锁）")])]),s._v(" "),n("p",[s._v("共享锁和排它锁，**都不允许 **其他事务 "),n("strong",[s._v("执行写操作")]),s._v("，但是可以读数据。")]),s._v(" "),n("p",[s._v("排他锁不允许对数据再加另外的锁。")]),s._v(" "),n("h2",{attrs:{id:"共享锁"}},[n("a",{staticClass:"header-anchor",attrs:{href:"#共享锁"}},[s._v("#")]),s._v(" 共享锁")]),s._v(" "),n("p",[s._v("只有 serializable 事务隔离级别，才会给数据添加共享锁。也可以手动添加共享锁")]),s._v(" "),n("div",{staticClass:"language-sql line-numbers-mode"},[n("pre",{pre:!0,attrs:{class:"language-sql"}},[n("code",[n("span",{pre:!0,attrs:{class:"token keyword"}},[s._v("select")]),s._v(" "),n("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(".")]),n("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(".")]),n("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(".")]),s._v(" "),n("span",{pre:!0,attrs:{class:"token keyword"}},[s._v("from")]),s._v(" "),n("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(".")]),n("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(".")]),n("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(".")]),s._v(" "),n("span",{pre:!0,attrs:{class:"token keyword"}},[s._v("lock")]),s._v(" "),n("span",{pre:!0,attrs:{class:"token operator"}},[s._v("in")]),s._v(" "),n("span",{pre:!0,attrs:{class:"token keyword"}},[s._v("share")]),s._v(" "),n("span",{pre:!0,attrs:{class:"token keyword"}},[s._v("mode")]),n("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(";")]),s._v("\n")])]),s._v(" "),n("div",{staticClass:"line-numbers-wrapper"},[n("span",{staticClass:"line-number"},[s._v("1")]),n("br")])]),n("p",[s._v("事务不提交，该共享锁不会被释放，其他事务只能读取数据，而不能写数据。")]),s._v(" "),n("p",[s._v("如下面的测试")]),s._v(" "),n("div",{staticClass:"language-sql line-numbers-mode"},[n("pre",{pre:!0,attrs:{class:"language-sql"}},[n("code",[n("span",{pre:!0,attrs:{class:"token comment"}},[s._v("-- 会话 1")]),s._v("\n"),n("span",{pre:!0,attrs:{class:"token comment"}},[s._v("-- 开启事物，并查询前 10 条记录")]),s._v("\n"),n("span",{pre:!0,attrs:{class:"token keyword"}},[s._v("BEGIN")]),n("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(";")]),s._v("\n"),n("span",{pre:!0,attrs:{class:"token keyword"}},[s._v("SELECT")]),s._v("\n\t\t"),n("span",{pre:!0,attrs:{class:"token operator"}},[s._v("*")]),s._v(" \n\t"),n("span",{pre:!0,attrs:{class:"token keyword"}},[s._v("FROM")]),s._v("\n\t\tt_test \n"),n("span",{pre:!0,attrs:{class:"token keyword"}},[s._v("WHERE")]),s._v("\n\tid "),n("span",{pre:!0,attrs:{class:"token operator"}},[s._v("<=")]),s._v(" "),n("span",{pre:!0,attrs:{class:"token number"}},[s._v("10")]),s._v(" "),n("span",{pre:!0,attrs:{class:"token keyword"}},[s._v("LOCK")]),s._v(" "),n("span",{pre:!0,attrs:{class:"token operator"}},[s._v("IN")]),s._v(" "),n("span",{pre:!0,attrs:{class:"token keyword"}},[s._v("SHARE")]),s._v(" "),n("span",{pre:!0,attrs:{class:"token keyword"}},[s._v("MODE")]),n("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(";")]),s._v("\n\t\n"),n("span",{pre:!0,attrs:{class:"token comment"}},[s._v("-- 先不提交事务，去 会话 2，执行更新操作")]),s._v("\n"),n("span",{pre:!0,attrs:{class:"token keyword"}},[s._v("COMMIT")]),n("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(";")]),s._v("\n\n\n"),n("span",{pre:!0,attrs:{class:"token comment"}},[s._v("-- 会话 2")]),s._v("\n"),n("span",{pre:!0,attrs:{class:"token comment"}},[s._v("-- 开启事物，并执行更新语句")]),s._v("\n"),n("span",{pre:!0,attrs:{class:"token keyword"}},[s._v("BEGIN")]),n("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(";")]),s._v("\n"),n("span",{pre:!0,attrs:{class:"token keyword"}},[s._v("UPDATE")]),s._v(" t_test \n\t"),n("span",{pre:!0,attrs:{class:"token keyword"}},[s._v("SET")]),s._v(" "),n("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("`")]),s._v("name"),n("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("`")]),s._v(" "),n("span",{pre:!0,attrs:{class:"token operator"}},[s._v("=")]),s._v(" "),n("span",{pre:!0,attrs:{class:"token string"}},[s._v("'abc'")]),s._v(" \n"),n("span",{pre:!0,attrs:{class:"token keyword"}},[s._v("WHERE")]),s._v("\n\tid "),n("span",{pre:!0,attrs:{class:"token operator"}},[s._v("<=")]),s._v(" "),n("span",{pre:!0,attrs:{class:"token number"}},[s._v("10")]),n("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(";")]),s._v("\n"),n("span",{pre:!0,attrs:{class:"token comment"}},[s._v("-- 会发现更新语句被阻塞了，要等待会话 1 释放共享锁")]),s._v("\n\n"),n("span",{pre:!0,attrs:{class:"token comment"}},[s._v("-- 可以回滚该事务，不让修改生效")]),s._v("\n"),n("span",{pre:!0,attrs:{class:"token keyword"}},[s._v("ROLLBACK")]),n("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(";")]),s._v("\n")])]),s._v(" "),n("div",{staticClass:"line-numbers-wrapper"},[n("span",{staticClass:"line-number"},[s._v("1")]),n("br"),n("span",{staticClass:"line-number"},[s._v("2")]),n("br"),n("span",{staticClass:"line-number"},[s._v("3")]),n("br"),n("span",{staticClass:"line-number"},[s._v("4")]),n("br"),n("span",{staticClass:"line-number"},[s._v("5")]),n("br"),n("span",{staticClass:"line-number"},[s._v("6")]),n("br"),n("span",{staticClass:"line-number"},[s._v("7")]),n("br"),n("span",{staticClass:"line-number"},[s._v("8")]),n("br"),n("span",{staticClass:"line-number"},[s._v("9")]),n("br"),n("span",{staticClass:"line-number"},[s._v("10")]),n("br"),n("span",{staticClass:"line-number"},[s._v("11")]),n("br"),n("span",{staticClass:"line-number"},[s._v("12")]),n("br"),n("span",{staticClass:"line-number"},[s._v("13")]),n("br"),n("span",{staticClass:"line-number"},[s._v("14")]),n("br"),n("span",{staticClass:"line-number"},[s._v("15")]),n("br"),n("span",{staticClass:"line-number"},[s._v("16")]),n("br"),n("span",{staticClass:"line-number"},[s._v("17")]),n("br"),n("span",{staticClass:"line-number"},[s._v("18")]),n("br"),n("span",{staticClass:"line-number"},[s._v("19")]),n("br"),n("span",{staticClass:"line-number"},[s._v("20")]),n("br"),n("span",{staticClass:"line-number"},[s._v("21")]),n("br"),n("span",{staticClass:"line-number"},[s._v("22")]),n("br"),n("span",{staticClass:"line-number"},[s._v("23")]),n("br"),n("span",{staticClass:"line-number"},[s._v("24")]),n("br"),n("span",{staticClass:"line-number"},[s._v("25")]),n("br")])]),n("h2",{attrs:{id:"排他锁"}},[n("a",{staticClass:"header-anchor",attrs:{href:"#排他锁"}},[s._v("#")]),s._v(" 排他锁")]),s._v(" "),n("p",[s._v("MySQL 会 "),n("strong",[s._v("默认")]),s._v(" 给添加、修改和删除记录，设置排他锁。")]),s._v(" "),n("p",[s._v("手动添加排他锁的语法为")]),s._v(" "),n("div",{staticClass:"language-sql line-numbers-mode"},[n("pre",{pre:!0,attrs:{class:"language-sql"}},[n("code",[n("span",{pre:!0,attrs:{class:"token keyword"}},[s._v("select")]),s._v(" "),n("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(".")]),n("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(".")]),n("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(".")]),s._v(" "),n("span",{pre:!0,attrs:{class:"token keyword"}},[s._v("from")]),s._v(" "),n("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(".")]),n("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(".")]),n("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(".")]),s._v(" "),n("span",{pre:!0,attrs:{class:"token keyword"}},[s._v("for")]),s._v(" "),n("span",{pre:!0,attrs:{class:"token keyword"}},[s._v("update")]),n("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(";")]),s._v("\n")])]),s._v(" "),n("div",{staticClass:"line-numbers-wrapper"},[n("span",{staticClass:"line-number"},[s._v("1")]),n("br")])]),n("p",[s._v("可以对该数据进行查询，但是不能对加了排它锁的数据进行修改。（同时也不能对该数据加排他锁了）")]),s._v(" "),n("h2",{attrs:{id:"如何减少并发操作的锁冲突？"}},[n("a",{staticClass:"header-anchor",attrs:{href:"#如何减少并发操作的锁冲突？"}},[s._v("#")]),s._v(" 如何减少并发操作的锁冲突？")]),s._v(" "),n("p",[s._v("把复杂的 SQL 语句，拆分成多条简单的 SQL 语句。")]),s._v(" "),n("p",[s._v("复杂 SQL 语句执行时间长，锁时间长，拆分成简单的语句，每次锁定数据少，锁时间短")])])}),[],!1,null,null,null);t.default=e.exports}}]);